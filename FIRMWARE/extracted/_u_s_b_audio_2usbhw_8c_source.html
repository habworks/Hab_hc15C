<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>LPC1700CMSIS Standard Peripheral Firmware Library Manual: C:/nxpdrv/LPC1700CMSIS/Examples/USBDEV/USBAudio/usbhw.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>C:/nxpdrv/LPC1700CMSIS/Examples/USBDEV/USBAudio/usbhw.c</h1><a href="_u_s_b_audio_2usbhw_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment"> *      U S B  -  K e r n e l</span>
<a name="l00003"></a>00003 <span class="comment"> *----------------------------------------------------------------------------</span>
<a name="l00004"></a>00004 <span class="comment"> * Name:    usbhw.c</span>
<a name="l00005"></a>00005 <span class="comment"> * Purpose: USB Hardware Layer Module for NXP's LPC17xx MCU</span>
<a name="l00006"></a>00006 <span class="comment"> * Version: V1.20</span>
<a name="l00007"></a>00007 <span class="comment"> *----------------------------------------------------------------------------</span>
<a name="l00008"></a>00008 <span class="comment"> *      This software is supplied "AS IS" without any warranties, express,</span>
<a name="l00009"></a>00009 <span class="comment"> *      implied or statutory, including but not limited to the implied</span>
<a name="l00010"></a>00010 <span class="comment"> *      warranties of fitness for purpose, satisfactory quality and</span>
<a name="l00011"></a>00011 <span class="comment"> *      noninfringement. Keil extends you a royalty-free right to reproduce</span>
<a name="l00012"></a>00012 <span class="comment"> *      and distribute executable files created using this software for use</span>
<a name="l00013"></a>00013 <span class="comment"> *      on NXP Semiconductors LPC family microcontroller devices only. Nothing</span>
<a name="l00014"></a>00014 <span class="comment"> *      else gives you the right to use this software.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * Copyright (c) 2009 Keil - An ARM Company. All rights reserved.</span>
<a name="l00017"></a>00017 <span class="comment"> *----------------------------------------------------------------------------</span>
<a name="l00018"></a>00018 <span class="comment"> * History:</span>
<a name="l00019"></a>00019 <span class="comment"> *          V1.20 Added USB_ClearEPBuf</span>
<a name="l00020"></a>00020 <span class="comment"> *          V1.00 Initial Version</span>
<a name="l00021"></a>00021 <span class="comment"> *----------------------------------------------------------------------------*/</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_l_p_c17xx_8h.html" title="CMSIS Cortex-M3 Core Peripheral Access Layer Header File for NXP LPC17xx Device Series...">LPC17xx.h</a>"</span>                        <span class="comment">/* LPC17xx definitions */</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="lpc__types_8h.html" title="Contains the NXP ABL typedefs for C standard types. It is intended to be used in...">lpc_types.h</a>"</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usb_8h.html">usb.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usbcfg_8h.html">usbcfg.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usbreg_8h.html">usbreg.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usbhw_8h.html">usbhw.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usbcore_8h.html">usbcore.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="_u_s_b_audio_2usbuser_8h.html">usbuser.h</a>"</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#if defined  (  __CC_ARM__  )</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#pragma diag_suppress 1441</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#5758b262e45f1476b85c72d261bf151f">00037</a> <span class="preprocessor">#define EP_MSK_CTRL 0x0001      </span><span class="comment">/* Control Endpoint Logical Address Mask */</span>
<a name="l00038"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#6cb1cd31933803cdf8facab393cb67b5">00038</a> <span class="preprocessor">#define EP_MSK_BULK 0xC924      </span><span class="comment">/* Bulk Endpoint Logical Address Mask */</span>
<a name="l00039"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#53236c5802d284e03c20bbe414999f8a">00039</a> <span class="preprocessor">#define EP_MSK_INT  0x4492      </span><span class="comment">/* Interrupt Endpoint Logical Address Mask */</span>
<a name="l00040"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#873b434da89b1922b604ba5730412e19">00040</a> <span class="preprocessor">#define EP_MSK_ISO  0x1248      </span><span class="comment">/* Isochronous Endpoint Logical Address Mask */</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#if USB_DMA</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#pragma arm section zidata = "USB_RAM"</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>uint32_t UDCA[<a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>];                     <span class="comment">/* UDCA in USB RAM */</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 uint32_t DD_NISO_Mem[4*<a class="code" href="_u_s_b_audio_2usbhw_8h.html#16bdb96a1b001316d00510bf3bad307f">DD_NISO_CNT</a>];           <span class="comment">/* Non-Iso DMA Descriptor Memory */</span>
<a name="l00049"></a>00049 uint32_t DD_ISO_Mem [5*<a class="code" href="_u_s_b_audio_2usbhw_8h.html#b57313fa2311cac50212a22f10ff3db4">DD_ISO_CNT</a>];            <span class="comment">/* Iso DMA Descriptor Memory */</span>
<a name="l00050"></a>00050 <span class="preprocessor">#pragma arm section zidata</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>uint32_t udca[<a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>];                     <span class="comment">/* UDCA saved values */</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 uint32_t DDMemMap[2];                          <span class="comment">/* DMA Descriptor Memory Usage */</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="comment">/*</span>
<a name="l00059"></a>00059 <span class="comment"> *  Get Endpoint Physical Address</span>
<a name="l00060"></a>00060 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00061"></a>00061 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00062"></a>00062 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00063"></a>00063 <span class="comment"> *    Return Value:    Endpoint Physical Address</span>
<a name="l00064"></a>00064 <span class="comment"> */</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">00066</a> uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a> (uint32_t EPNum) {
<a name="l00067"></a>00067   uint32_t val;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069   val = (EPNum &amp; 0x0F) &lt;&lt; 1;
<a name="l00070"></a>00070   <span class="keywordflow">if</span> (EPNum &amp; 0x80) {
<a name="l00071"></a>00071     val += 1;
<a name="l00072"></a>00072   }
<a name="l00073"></a>00073   <span class="keywordflow">return</span> (val);
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/*</span>
<a name="l00078"></a>00078 <span class="comment"> *  Write Command</span>
<a name="l00079"></a>00079 <span class="comment"> *    Parameters:      cmd:   Command</span>
<a name="l00080"></a>00080 <span class="comment"> *    Return Value:    None</span>
<a name="l00081"></a>00081 <span class="comment"> */</span>
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#43a57d8b8cb335d6c95b8517a46c244f">00083</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#43a57d8b8cb335d6c95b8517a46c244f">WrCmd</a> (uint32_t cmd) {
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>;
<a name="l00086"></a>00086   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = cmd;
<a name="l00087"></a>00087   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>) == 0);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/*</span>
<a name="l00092"></a>00092 <span class="comment"> *  Write Command Data</span>
<a name="l00093"></a>00093 <span class="comment"> *    Parameters:      cmd:   Command</span>
<a name="l00094"></a>00094 <span class="comment"> *                     val:   Data</span>
<a name="l00095"></a>00095 <span class="comment"> *    Return Value:    None</span>
<a name="l00096"></a>00096 <span class="comment"> */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">00098</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a> (uint32_t cmd, uint32_t val) {
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>;
<a name="l00101"></a>00101   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = cmd;
<a name="l00102"></a>00102   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>) == 0);
<a name="l00103"></a>00103   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>;
<a name="l00104"></a>00104   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = val;
<a name="l00105"></a>00105   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>) == 0);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="comment">/*</span>
<a name="l00110"></a>00110 <span class="comment"> *  Write Command to Endpoint</span>
<a name="l00111"></a>00111 <span class="comment"> *    Parameters:      cmd:   Command</span>
<a name="l00112"></a>00112 <span class="comment"> *                     val:   Data</span>
<a name="l00113"></a>00113 <span class="comment"> *    Return Value:    None</span>
<a name="l00114"></a>00114 <span class="comment"> */</span>
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#ff86a67a8cc3b52fae0e91e96557fc60">00116</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#ff86a67a8cc3b52fae0e91e96557fc60">WrCmdEP</a> (uint32_t EPNum, uint32_t cmd){
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>;
<a name="l00119"></a>00119   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#080b7d4b7fbb1eb8fb66ddbc31ac0335">CMD_SEL_EP</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum));
<a name="l00120"></a>00120   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>) == 0);
<a name="l00121"></a>00121   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>;
<a name="l00122"></a>00122   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = cmd;
<a name="l00123"></a>00123   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a>) == 0);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/*</span>
<a name="l00128"></a>00128 <span class="comment"> *  Read Command Data</span>
<a name="l00129"></a>00129 <span class="comment"> *    Parameters:      cmd:   Command</span>
<a name="l00130"></a>00130 <span class="comment"> *    Return Value:    Data Value</span>
<a name="l00131"></a>00131 <span class="comment"> */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">00133</a> uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">RdCmdDat</a> (uint32_t cmd) {
<a name="l00134"></a>00134 
<a name="l00135"></a>00135   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#137c7c5f6c2b0421f42b62f9d6e7168b">CCEMTY_INT</a> | <a class="code" href="_u_s_b_audio_2usbreg_8h.html#406c6e1ace2c70ee7f264957ce417a45">CDFULL_INT</a>;
<a name="l00136"></a>00136   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdCode = cmd;
<a name="l00137"></a>00137   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#406c6e1ace2c70ee7f264957ce417a45">CDFULL_INT</a>) == 0);
<a name="l00138"></a>00138   <span class="keywordflow">return</span> (<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdData);
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="comment">/*</span>
<a name="l00143"></a>00143 <span class="comment"> *  USB Initialize Function</span>
<a name="l00144"></a>00144 <span class="comment"> *   Called by the User to initialize USB</span>
<a name="l00145"></a>00145 <span class="comment"> *    Return Value:    None</span>
<a name="l00146"></a>00146 <span class="comment"> */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#35fe971cbcbfe8813199e869284cb862">00148</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#35fe971cbcbfe8813199e869284cb862">USB_Init</a> (<span class="keywordtype">void</span>) {
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL1 &amp;= ~((3&lt;&lt;26)|(3&lt;&lt;28));   <span class="comment">/* P0.29 D+, P0.30 D- */</span>
<a name="l00151"></a>00151   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL1 |=  ((1&lt;&lt;26)|(1&lt;&lt;28));   <span class="comment">/* PINSEL1 26.27, 28.29  = 01 */</span>
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL3 &amp;= ~((3&lt;&lt; 4)|(3&lt;&lt;28));   <span class="comment">/* P1.18 GoodLink, P1.30 VBUS */</span>
<a name="l00154"></a>00154   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL3 |=  ((1&lt;&lt; 4)|(2&lt;&lt;28));   <span class="comment">/* PINSEL3 4.5 = 01, 28.29 = 10 */</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL4 &amp;= ~((3&lt;&lt;18)        );   <span class="comment">/* P2.9 SoftConnect */</span>
<a name="l00157"></a>00157   <a class="code" href="group___l_p_c17xx___system.html#ge30bef900c4cccded0c66548b38591f9">LPC_PINCON</a>-&gt;PINSEL4 |=  ((1&lt;&lt;18)        );   <span class="comment">/* PINSEL4 18.19 = 01 */</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <a class="code" href="group___l_p_c17xx___system.html#gc01c7f61bb84ad209eec22ec5c05446d">LPC_SC</a>-&gt;PCONP |= (1UL&lt;&lt;31);                <span class="comment">/* USB PCLK -&gt; enable USB Per.       */</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBClkCtrl = 0x1A;                <span class="comment">/* Dev, PortSel, AHB clock enable */</span>
<a name="l00162"></a>00162   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBClkSt &amp; 0x1A) != 0x1A);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   NVIC_EnableIRQ(<a class="code" href="group___l_p_c17xx___system.html#gg666eb0caeb12ec0e281415592ae890835078f46ddc47f29eae4aa40bd57d1692">USB_IRQn</a>);               <span class="comment">/* enable USB interrupt */</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#bfc0896707a9437a0c3b0ac611da59aa">USB_Reset</a>();
<a name="l00167"></a>00167   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e0b5ab428469821dab3912e9a9540f38">USB_SetAddress</a>(0);
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">/*</span>
<a name="l00172"></a>00172 <span class="comment"> *  USB Connect Function</span>
<a name="l00173"></a>00173 <span class="comment"> *   Called by the User to Connect/Disconnect USB</span>
<a name="l00174"></a>00174 <span class="comment"> *    Parameters:      con:   Connect/Disconnect</span>
<a name="l00175"></a>00175 <span class="comment"> *    Return Value:    None</span>
<a name="l00176"></a>00176 <span class="comment"> */</span>
<a name="l00177"></a>00177 
<a name="l00178"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#7b4ca59fc7f1a1f0e83b84a225fbe16e">00178</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#7b4ca59fc7f1a1f0e83b84a225fbe16e">USB_Connect</a> (uint32_t con) {
<a name="l00179"></a>00179   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#53990f82aee1e3b7d0e10456f265229c">CMD_SET_DEV_STAT</a>, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(con ? <a class="code" href="_u_s_b_audio_2usbreg_8h.html#5b6f5830c79daef183553eba90a74563">DEV_CON</a> : 0));
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment">/*</span>
<a name="l00184"></a>00184 <span class="comment"> *  USB Reset Function</span>
<a name="l00185"></a>00185 <span class="comment"> *   Called automatically on USB Reset</span>
<a name="l00186"></a>00186 <span class="comment"> *    Return Value:    None</span>
<a name="l00187"></a>00187 <span class="comment"> */</span>
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#bfc0896707a9437a0c3b0ac611da59aa">00189</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#bfc0896707a9437a0c3b0ac611da59aa">USB_Reset</a> (<span class="keywordtype">void</span>) {
<a name="l00190"></a>00190 <span class="preprocessor">#if USB_DMA</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>  uint32_t n;
<a name="l00192"></a>00192 <span class="preprocessor">#endif</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>
<a name="l00194"></a>00194   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpInd = 0;
<a name="l00195"></a>00195   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBMaxPSize = <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#4659143950f825db983fadc9a1b1df4e">USB_MAX_PACKET0</a>;
<a name="l00196"></a>00196   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpInd = 1;
<a name="l00197"></a>00197   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBMaxPSize = <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#4659143950f825db983fadc9a1b1df4e">USB_MAX_PACKET0</a>;
<a name="l00198"></a>00198   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#9c9b23320dbc3649f4eed4e91d190ad7">EP_RLZED_INT</a>) == 0);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpIntClr  = 0xFFFFFFFF;
<a name="l00201"></a>00201   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpIntEn   = 0xFFFFFFFF ^ <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#c16ed2a4344d3faa340bd08713b6c5a8">USB_DMA_EP</a>;
<a name="l00202"></a>00202   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = 0xFFFFFFFF;
<a name="l00203"></a>00203   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntEn  = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#f275198989acad4e8a4e2b7e59a09c8a">DEV_STAT_INT</a>    | <a class="code" href="_u_s_b_audio_2usbreg_8h.html#525aa5f17d8eef8bcc680f818718c35f">EP_SLOW_INT</a>    |
<a name="l00204"></a>00204                (<a class="code" href="_u_s_b_audio_2usbcfg_8h.html#1a66c59314a44e9f962de45866d105ea">USB_SOF_EVENT</a>   ? <a class="code" href="_u_s_b_audio_2usbreg_8h.html#cd810cb2c578feb523e4457a3ecc5c1f">FRAME_INT</a> : 0) |
<a name="l00205"></a>00205                (<a class="code" href="_u_s_b_audio_2usbcfg_8h.html#b989757af7f7e2a035ed38e592f481a6">USB_ERROR_EVENT</a> ? <a class="code" href="_u_s_b_audio_2usbreg_8h.html#d008a7e4bb0e20f144f938e9bd1735ed">ERR_INT</a>   : 0);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="preprocessor">#if USB_DMA</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>  <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBUDCAH   = <a class="code" href="_u_s_b_audio_2usbhw_8h.html#d77e06d7cc141b63033f1fcb40f99d50">USB_RAM_ADR</a>;
<a name="l00209"></a>00209   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDMARClr = 0xFFFFFFFF;
<a name="l00210"></a>00210   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpDMADis  = 0xFFFFFFFF;
<a name="l00211"></a>00211   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpDMAEn   = <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#c16ed2a4344d3faa340bd08713b6c5a8">USB_DMA_EP</a>;
<a name="l00212"></a>00212   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEoTIntClr = 0xFFFFFFFF;
<a name="l00213"></a>00213   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBNDDRIntClr = 0xFFFFFFFF;
<a name="l00214"></a>00214   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBSysErrIntClr = 0xFFFFFFFF;
<a name="l00215"></a>00215   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDMAIntEn  = 0x00000007;
<a name="l00216"></a>00216   DDMemMap[0] = 0x00000000;
<a name="l00217"></a>00217   DDMemMap[1] = 0x00000000;
<a name="l00218"></a>00218   <span class="keywordflow">for</span> (n = 0; n &lt; <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>; n++) {
<a name="l00219"></a>00219     udca[n] = 0;
<a name="l00220"></a>00220     UDCA[n] = 0;
<a name="l00221"></a>00221   }
<a name="l00222"></a>00222 <span class="preprocessor">#endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>}
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="comment">/*</span>
<a name="l00227"></a>00227 <span class="comment"> *  USB Suspend Function</span>
<a name="l00228"></a>00228 <span class="comment"> *   Called automatically on USB Suspend</span>
<a name="l00229"></a>00229 <span class="comment"> *    Return Value:    None</span>
<a name="l00230"></a>00230 <span class="comment"> */</span>
<a name="l00231"></a>00231 
<a name="l00232"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#87b4006411b630cc848d30b3e8a53e34">00232</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#87b4006411b630cc848d30b3e8a53e34">USB_Suspend</a> (<span class="keywordtype">void</span>) {
<a name="l00233"></a>00233   <span class="comment">/* Performed by Hardware */</span>
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">/*</span>
<a name="l00238"></a>00238 <span class="comment"> *  USB Resume Function</span>
<a name="l00239"></a>00239 <span class="comment"> *   Called automatically on USB Resume</span>
<a name="l00240"></a>00240 <span class="comment"> *    Return Value:    None</span>
<a name="l00241"></a>00241 <span class="comment"> */</span>
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#690e53ae70763bf28c20fbf55b28b1c5">00243</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#690e53ae70763bf28c20fbf55b28b1c5">USB_Resume</a> (<span class="keywordtype">void</span>) {
<a name="l00244"></a>00244   <span class="comment">/* Performed by Hardware */</span>
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">/*</span>
<a name="l00249"></a>00249 <span class="comment"> *  USB Remote Wakeup Function</span>
<a name="l00250"></a>00250 <span class="comment"> *   Called automatically on USB Remote Wakeup</span>
<a name="l00251"></a>00251 <span class="comment"> *    Return Value:    None</span>
<a name="l00252"></a>00252 <span class="comment"> */</span>
<a name="l00253"></a>00253 
<a name="l00254"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#076f3794dcd3ff5b60ad10ea702424ca">00254</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#076f3794dcd3ff5b60ad10ea702424ca">USB_WakeUp</a> (<span class="keywordtype">void</span>) {
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbcore_8c.html#e17f48735d8b5053e39fa7d808ff99d4">USB_DeviceStatus</a> &amp; <a class="code" href="_u_s_b_audio_2usb_8h.html#ad5790ebb5c8f5a25ce60140c60c2ec5">USB_GETSTATUS_REMOTE_WAKEUP</a>) {
<a name="l00257"></a>00257     <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#53990f82aee1e3b7d0e10456f265229c">CMD_SET_DEV_STAT</a>, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#5b6f5830c79daef183553eba90a74563">DEV_CON</a>));
<a name="l00258"></a>00258   }
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">/*</span>
<a name="l00263"></a>00263 <span class="comment"> *  USB Remote Wakeup Configuration Function</span>
<a name="l00264"></a>00264 <span class="comment"> *    Parameters:      cfg:   Enable/Disable</span>
<a name="l00265"></a>00265 <span class="comment"> *    Return Value:    None</span>
<a name="l00266"></a>00266 <span class="comment"> */</span>
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#54c351f13ebe958dba0174e60d76d091">00268</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#54c351f13ebe958dba0174e60d76d091">USB_WakeUpCfg</a> (uint32_t cfg) {
<a name="l00269"></a>00269   <span class="comment">/* Not needed */</span>
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/*</span>
<a name="l00274"></a>00274 <span class="comment"> *  USB Set Address Function</span>
<a name="l00275"></a>00275 <span class="comment"> *    Parameters:      adr:   USB Address</span>
<a name="l00276"></a>00276 <span class="comment"> *    Return Value:    None</span>
<a name="l00277"></a>00277 <span class="comment"> */</span>
<a name="l00278"></a>00278 
<a name="l00279"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#e0b5ab428469821dab3912e9a9540f38">00279</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e0b5ab428469821dab3912e9a9540f38">USB_SetAddress</a> (uint32_t adr) {
<a name="l00280"></a>00280   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#476471f02bd7f90ee2855990f76efada">CMD_SET_ADDR</a>, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#cbd2d57f1c7a43cf4e92e924dbdc99bd">DEV_EN</a> | adr)); <span class="comment">/* Don't wait for next */</span>
<a name="l00281"></a>00281   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#476471f02bd7f90ee2855990f76efada">CMD_SET_ADDR</a>, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#cbd2d57f1c7a43cf4e92e924dbdc99bd">DEV_EN</a> | adr)); <span class="comment">/*  Setup Status Phase */</span>
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="comment">/*</span>
<a name="l00286"></a>00286 <span class="comment"> *  USB Configure Function</span>
<a name="l00287"></a>00287 <span class="comment"> *    Parameters:      cfg:   Configure/Deconfigure</span>
<a name="l00288"></a>00288 <span class="comment"> *    Return Value:    None</span>
<a name="l00289"></a>00289 <span class="comment"> */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#81076c3d311332233df6add5da3f96a3">00291</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#81076c3d311332233df6add5da3f96a3">USB_Configure</a> (uint32_t cfg) {
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#a4e27b27ac428813be32594783f30e72">CMD_CFG_DEV</a>, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(cfg ? <a class="code" href="_u_s_b_audio_2usbreg_8h.html#82ac0c8908b3c85689d9b4f773403296">CONF_DVICE</a> : 0));
<a name="l00294"></a>00294 
<a name="l00295"></a>00295   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBReEp = 0x00000003;
<a name="l00296"></a>00296   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#9c9b23320dbc3649f4eed4e91d190ad7">EP_RLZED_INT</a>) == 0);
<a name="l00297"></a>00297   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#9c9b23320dbc3649f4eed4e91d190ad7">EP_RLZED_INT</a>;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="comment">/*</span>
<a name="l00302"></a>00302 <span class="comment"> *  Configure USB Endpoint according to Descriptor</span>
<a name="l00303"></a>00303 <span class="comment"> *    Parameters:      pEPD:  Pointer to Endpoint Descriptor</span>
<a name="l00304"></a>00304 <span class="comment"> *    Return Value:    None</span>
<a name="l00305"></a>00305 <span class="comment"> */</span>
<a name="l00306"></a>00306 
<a name="l00307"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#54a2914070c64801b8d8942b787fffad">00307</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#54a2914070c64801b8d8942b787fffad">USB_ConfigEP</a> (<a class="code" href="_u_s_b_audio_2usb_8h.html#0e69c6f54cfc1417c35338fec9ca3267">USB_ENDPOINT_DESCRIPTOR</a> *pEPD) {
<a name="l00308"></a>00308   uint32_t num;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   num = <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(pEPD-&gt;bEndpointAddress);
<a name="l00311"></a>00311   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBReEp |= (1 &lt;&lt; num);
<a name="l00312"></a>00312   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpInd = num;
<a name="l00313"></a>00313   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBMaxPSize = pEPD-&gt;wMaxPacketSize;
<a name="l00314"></a>00314   <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#9c9b23320dbc3649f4eed4e91d190ad7">EP_RLZED_INT</a>) == 0);
<a name="l00315"></a>00315   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = <a class="code" href="_u_s_b_audio_2usbreg_8h.html#9c9b23320dbc3649f4eed4e91d190ad7">EP_RLZED_INT</a>;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">/*</span>
<a name="l00320"></a>00320 <span class="comment"> *  Set Direction for USB Control Endpoint</span>
<a name="l00321"></a>00321 <span class="comment"> *    Parameters:      dir:   Out (dir == 0), In (dir &lt;&gt; 0)</span>
<a name="l00322"></a>00322 <span class="comment"> *    Return Value:    None</span>
<a name="l00323"></a>00323 <span class="comment"> */</span>
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#40574e013f7a24918ec441ed3fa2a2f0">00325</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#40574e013f7a24918ec441ed3fa2a2f0">USB_DirCtrlEP</a> (uint32_t dir) {
<a name="l00326"></a>00326   <span class="comment">/* Not needed */</span>
<a name="l00327"></a>00327 }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/*</span>
<a name="l00331"></a>00331 <span class="comment"> *  Enable USB Endpoint</span>
<a name="l00332"></a>00332 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00333"></a>00333 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00334"></a>00334 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00335"></a>00335 <span class="comment"> *    Return Value:    None</span>
<a name="l00336"></a>00336 <span class="comment"> */</span>
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#1b6c972b5b73b220f4d7e73100710eb4">00338</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1b6c972b5b73b220f4d7e73100710eb4">USB_EnableEP</a> (uint32_t EPNum) {
<a name="l00339"></a>00339   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#fb02e2bfca8f4b61a54a2aff9ae5c2f6">CMD_SET_EP_STAT</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)), <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(0));
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="comment">/*</span>
<a name="l00344"></a>00344 <span class="comment"> *  Disable USB Endpoint</span>
<a name="l00345"></a>00345 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00346"></a>00346 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00347"></a>00347 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00348"></a>00348 <span class="comment"> *    Return Value:    None</span>
<a name="l00349"></a>00349 <span class="comment"> */</span>
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#0f1afa965109023ca62d20bd4f06939b">00351</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#0f1afa965109023ca62d20bd4f06939b">USB_DisableEP</a> (uint32_t EPNum) {
<a name="l00352"></a>00352   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#fb02e2bfca8f4b61a54a2aff9ae5c2f6">CMD_SET_EP_STAT</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)), <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#c2c74d5169ac4c23bb42f9bc5ad520bf">EP_STAT_DA</a>));
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">/*</span>
<a name="l00357"></a>00357 <span class="comment"> *  Reset USB Endpoint</span>
<a name="l00358"></a>00358 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00359"></a>00359 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00360"></a>00360 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00361"></a>00361 <span class="comment"> *    Return Value:    None</span>
<a name="l00362"></a>00362 <span class="comment"> */</span>
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#828653e11c72bafde7e5db8baad167d4">00364</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#828653e11c72bafde7e5db8baad167d4">USB_ResetEP</a> (uint32_t EPNum) {
<a name="l00365"></a>00365   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#fb02e2bfca8f4b61a54a2aff9ae5c2f6">CMD_SET_EP_STAT</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)), <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(0));
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="comment">/*</span>
<a name="l00370"></a>00370 <span class="comment"> *  Set Stall for USB Endpoint</span>
<a name="l00371"></a>00371 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00372"></a>00372 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00373"></a>00373 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00374"></a>00374 <span class="comment"> *    Return Value:    None</span>
<a name="l00375"></a>00375 <span class="comment"> */</span>
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#5f634777bb45210732ae255dfd757cbb">00377</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#5f634777bb45210732ae255dfd757cbb">USB_SetStallEP</a> (uint32_t EPNum) {
<a name="l00378"></a>00378   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#fb02e2bfca8f4b61a54a2aff9ae5c2f6">CMD_SET_EP_STAT</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)), <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#39c8c109f3bcfc197aeb6512e807c378">EP_STAT_ST</a>));
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="comment">/*</span>
<a name="l00383"></a>00383 <span class="comment"> *  Clear Stall for USB Endpoint</span>
<a name="l00384"></a>00384 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00385"></a>00385 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00386"></a>00386 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00387"></a>00387 <span class="comment"> *    Return Value:    None</span>
<a name="l00388"></a>00388 <span class="comment"> */</span>
<a name="l00389"></a>00389 
<a name="l00390"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#bd72097df3fc6d6e487fa2e855d8af6c">00390</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#bd72097df3fc6d6e487fa2e855d8af6c">USB_ClrStallEP</a> (uint32_t EPNum) {
<a name="l00391"></a>00391   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#e88115ba5c676e7d806a8062f981525a">WrCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#fb02e2bfca8f4b61a54a2aff9ae5c2f6">CMD_SET_EP_STAT</a>(<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)), <a class="code" href="_u_s_b_audio_2usbreg_8h.html#3bdce5cc0b05eaaebe27f3b9e7db47e6">DAT_WR_BYTE</a>(0));
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="comment">/*</span>
<a name="l00396"></a>00396 <span class="comment"> *  Clear USB Endpoint Buffer</span>
<a name="l00397"></a>00397 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00398"></a>00398 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00399"></a>00399 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00400"></a>00400 <span class="comment"> *    Return Value:    None</span>
<a name="l00401"></a>00401 <span class="comment"> */</span>
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="_u_s_b_c_d_c_2usbhw_8h.html#6ffd705b6aa29ccdc13fc308f5149c5d">00403</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#6ffd705b6aa29ccdc13fc308f5149c5d">USB_ClearEPBuf</a> (uint32_t EPNum) {
<a name="l00404"></a>00404   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#ff86a67a8cc3b52fae0e91e96557fc60">WrCmdEP</a>(EPNum, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#e950d5b63a14f2f608d988beaf2290a2">CMD_CLR_BUF</a>);
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="comment">/*</span>
<a name="l00409"></a>00409 <span class="comment"> *  Read USB Endpoint Data</span>
<a name="l00410"></a>00410 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00411"></a>00411 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00412"></a>00412 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00413"></a>00413 <span class="comment"> *                     pData: Pointer to Data Buffer</span>
<a name="l00414"></a>00414 <span class="comment"> *    Return Value:    Number of bytes read</span>
<a name="l00415"></a>00415 <span class="comment"> */</span>
<a name="l00416"></a>00416 
<a name="l00417"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#99dc9c682a2fa25302005ee91a86a7e0">00417</a> uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8c.html#99dc9c682a2fa25302005ee91a86a7e0">USB_ReadEP</a> (uint32_t EPNum, uint8_t *pData) {
<a name="l00418"></a>00418   uint32_t cnt, n;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCtrl = ((EPNum &amp; 0x0F) &lt;&lt; 2) | <a class="code" href="_u_s_b_audio_2usbreg_8h.html#59d5f3760f8edf52f2e18584b72ff58f">CTRL_RD_EN</a>;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422   <span class="keywordflow">do</span> {
<a name="l00423"></a>00423     cnt = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBRxPLen;
<a name="l00424"></a>00424   } <span class="keywordflow">while</span> ((cnt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#b6390abfb762b0c8a5c5f14e535a8931">PKT_RDY</a>) == 0);
<a name="l00425"></a>00425   cnt &amp;= <a class="code" href="_u_s_b_audio_2usbreg_8h.html#7fb06bbe3370f59d8ab6a744d431f1f6">PKT_LNGTH_MASK</a>;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   <span class="keywordflow">for</span> (n = 0; n &lt; (cnt + 3) / 4; n++) {
<a name="l00428"></a>00428     *((__packed uint32_t *)pData) = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBRxData;
<a name="l00429"></a>00429     pData += 4;
<a name="l00430"></a>00430   }
<a name="l00431"></a>00431   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCtrl = 0;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="keywordflow">if</span> (((<a class="code" href="_u_s_b_audio_2usbhw_8c.html#873b434da89b1922b604ba5730412e19">EP_MSK_ISO</a> &gt;&gt; EPNum) &amp; 1) == 0) {   <span class="comment">/* Non-Isochronous Endpoint */</span>
<a name="l00434"></a>00434     <a class="code" href="_u_s_b_audio_2usbhw_8c.html#ff86a67a8cc3b52fae0e91e96557fc60">WrCmdEP</a>(EPNum, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#e950d5b63a14f2f608d988beaf2290a2">CMD_CLR_BUF</a>);
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436   <span class="keywordflow">return</span> (cnt);
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">/*</span>
<a name="l00441"></a>00441 <span class="comment"> *  Write USB Endpoint Data</span>
<a name="l00442"></a>00442 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00443"></a>00443 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00444"></a>00444 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00445"></a>00445 <span class="comment"> *                     pData: Pointer to Data Buffer</span>
<a name="l00446"></a>00446 <span class="comment"> *                     cnt:   Number of bytes to write</span>
<a name="l00447"></a>00447 <span class="comment"> *    Return Value:    Number of bytes written</span>
<a name="l00448"></a>00448 <span class="comment"> */</span>
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#36b8c7a6fd6052d4c52995d8553c0500">00450</a> uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8c.html#36b8c7a6fd6052d4c52995d8553c0500">USB_WriteEP</a> (uint32_t EPNum, uint8_t *pData, uint32_t cnt) {
<a name="l00451"></a>00451   uint32_t n;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCtrl = ((EPNum &amp; 0x0F) &lt;&lt; 2) | <a class="code" href="_u_s_b_audio_2usbreg_8h.html#eaa5968e571aa7d90329728836d4c498">CTRL_WR_EN</a>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBTxPLen = cnt;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <span class="keywordflow">for</span> (n = 0; n &lt; (cnt + 3) / 4; n++) {
<a name="l00458"></a>00458     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBTxData = *((__packed uint32_t *)pData);
<a name="l00459"></a>00459     pData += 4;
<a name="l00460"></a>00460   }
<a name="l00461"></a>00461   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCtrl = 0;
<a name="l00462"></a>00462   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#ff86a67a8cc3b52fae0e91e96557fc60">WrCmdEP</a>(EPNum, <a class="code" href="_u_s_b_audio_2usbreg_8h.html#555e6af6ea28f6963702de43e37df49f">CMD_VALID_BUF</a>);
<a name="l00463"></a>00463   <span class="keywordflow">return</span> (cnt);
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="preprocessor">#if USB_DMA</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>
<a name="l00468"></a>00468 <span class="comment">/* DMA Descriptor Memory Layout */</span>
<a name="l00469"></a>00469 <span class="keyword">const</span> uint32_t <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#4c42832cb054818f4860933678c34b31">DDAdr</a>[2] = { <a class="code" href="_u_s_b_audio_2usbhw_8h.html#314aba45ee06d31f1ae889f833bdbf45">DD_NISO_ADR</a>, <a class="code" href="_u_s_b_audio_2usbhw_8h.html#79c96bf45435b177398c836e32d081bc">DD_ISO_ADR</a> };
<a name="l00470"></a>00470 <span class="keyword">const</span> uint32_t <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#908fb61c6570999c8a314270730511c9">DDSz</a> [2] = { 16,          20         };
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="comment">/*</span>
<a name="l00474"></a>00474 <span class="comment"> *  Setup USB DMA Transfer for selected Endpoint</span>
<a name="l00475"></a>00475 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00476"></a>00476 <span class="comment"> *                     pDD: Pointer to DMA Descriptor</span>
<a name="l00477"></a>00477 <span class="comment"> *    Return Value:    TRUE - Success, FALSE - Error</span>
<a name="l00478"></a>00478 <span class="comment"> */</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8h.html#6668ef470c839449c1b4aa57870549b1">USB_DMA_Setup</a>(uint32_t EPNum, <a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html">USB_DMA_DESCRIPTOR</a> *pDD) {
<a name="l00481"></a>00481   uint32_t num, ptr, nxt, iso, n;
<a name="l00482"></a>00482   uint32_t *t;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   iso = pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.IsoEP;                <span class="comment">/* Iso or Non-Iso Descriptor */</span>
<a name="l00485"></a>00485   num = <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum);                       <span class="comment">/* Endpoint's Physical Address */</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   ptr = 0;                                  <span class="comment">/* Current Descriptor */</span>
<a name="l00488"></a>00488   nxt = udca[num];                          <span class="comment">/* Initial Descriptor */</span>
<a name="l00489"></a>00489   <span class="keywordflow">while</span> (nxt) {                             <span class="comment">/* Go through Descriptor List */</span>
<a name="l00490"></a>00490     ptr = nxt;                              <span class="comment">/* Current Descriptor */</span>
<a name="l00491"></a>00491     <span class="keywordflow">if</span> (!pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.Link) {              <span class="comment">/* Check for Linked Descriptors */</span>
<a name="l00492"></a>00492       n = (ptr - <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#4c42832cb054818f4860933678c34b31">DDAdr</a>[iso]) / <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#908fb61c6570999c8a314270730511c9">DDSz</a>[iso];   <span class="comment">/* Descriptor Index */</span>
<a name="l00493"></a>00493       DDMemMap[iso] &amp;= ~(1 &lt;&lt; n);           <span class="comment">/* Unmark Memory Usage */</span>
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     nxt = *((uint32_t *)ptr);                  <span class="comment">/* Next Descriptor */</span>
<a name="l00496"></a>00496   }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="keywordflow">for</span> (n = 0; n &lt; 32; n++) {                <span class="comment">/* Search for available Memory */</span>
<a name="l00499"></a>00499     <span class="keywordflow">if</span> ((DDMemMap[iso] &amp; (1 &lt;&lt; n)) == 0) {
<a name="l00500"></a>00500       <span class="keywordflow">break</span>;                                <span class="comment">/* Memory found */</span>
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502   }
<a name="l00503"></a>00503   <span class="keywordflow">if</span> (n == 32) <span class="keywordflow">return</span> (<a class="code" href="group___l_p_c___types___public___types.html#gg39db6982619d623273fad8a383489309a1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);              <span class="comment">/* Memory not available */</span>
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   DDMemMap[iso] |= 1 &lt;&lt; n;                  <span class="comment">/* Mark Memory Usage */</span>
<a name="l00506"></a>00506   nxt = <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#4c42832cb054818f4860933678c34b31">DDAdr</a>[iso] + n * <a class="code" href="_u_s_b_h_i_d_2usbhw_8c.html#908fb61c6570999c8a314270730511c9">DDSz</a>[iso];         <span class="comment">/* Next Descriptor */</span>
<a name="l00507"></a>00507 
<a name="l00508"></a>00508   <span class="keywordflow">if</span> (ptr &amp;&amp; pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.Link) {
<a name="l00509"></a>00509     *((uint32_t *)(ptr + 0))  = nxt;           <span class="comment">/* Link in new Descriptor */</span>
<a name="l00510"></a>00510     *((uint32_t *)(ptr + 4)) |= 0x00000004;    <span class="comment">/* Next DD is Valid */</span>
<a name="l00511"></a>00511   } <span class="keywordflow">else</span> {
<a name="l00512"></a>00512     udca[num] = nxt;                        <span class="comment">/* Save new Descriptor */</span>
<a name="l00513"></a>00513     UDCA[num] = nxt;                        <span class="comment">/* Update UDCA in USB */</span>
<a name="l00514"></a>00514   }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <span class="comment">/* Fill in DMA Descriptor */</span>
<a name="l00517"></a>00517   *(((uint32_t *)nxt)++) =  0;                 <span class="comment">/* Next DD Pointer */</span>
<a name="l00518"></a>00518   *(((uint32_t *)nxt)++) =  pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.ATLE |
<a name="l00519"></a>00519                        (pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.IsoEP &lt;&lt; 4) |
<a name="l00520"></a>00520                        (pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#ab25a34b921121874f41434f78e4c482">MaxSize</a> &lt;&lt;  5) |
<a name="l00521"></a>00521                        (pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#4bfc5f15389f2907bdff1af5716a4c53">BufLen</a>  &lt;&lt; 16);
<a name="l00522"></a>00522   *(((uint32_t *)nxt)++) =  pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#3ff3d5dcb28f25ab17ed74ce7d7c6b16">BufAdr</a>;
<a name="l00523"></a>00523   *(((uint32_t *)nxt)++) =  pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#389bc8dfc8072b13daa4835c20c2df79">Cfg</a>.<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#224c1448335892810f121b475ee82874">Type</a>.LenPos &lt;&lt; 8;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   <span class="keywordflow">if</span> (iso) {
<a name="l00526"></a>00526     *((uint32_t *)nxt) =  pDD-&gt;<a class="code" href="struct___u_s_b___d_m_a___d_e_s_c_r_i_p_t_o_r.html#ddf18e69d7b90bd910d5f75bbb4f79c8">InfoAdr</a>;
<a name="l00527"></a>00527   }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   <span class="keywordflow">return</span> (<a class="code" href="group___l_p_c___types___public___types.html#gg39db6982619d623273fad8a383489309a82764c3079aea4e60c80e45befbb839">TRUE</a>); <span class="comment">/* Success */</span>
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 <span class="comment">/*</span>
<a name="l00534"></a>00534 <span class="comment"> *  Enable USB DMA Endpoint</span>
<a name="l00535"></a>00535 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00536"></a>00536 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00537"></a>00537 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00538"></a>00538 <span class="comment"> *    Return Value:    None</span>
<a name="l00539"></a>00539 <span class="comment"> */</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8h.html#cef21b282006d5240b444168a8f82ad3">USB_DMA_Enable</a> (uint32_t EPNum) {
<a name="l00542"></a>00542   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpDMAEn = 1 &lt;&lt; <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum);
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="comment">/*</span>
<a name="l00547"></a>00547 <span class="comment"> *  Disable USB DMA Endpoint</span>
<a name="l00548"></a>00548 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00549"></a>00549 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00550"></a>00550 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00551"></a>00551 <span class="comment"> *    Return Value:    None</span>
<a name="l00552"></a>00552 <span class="comment"> */</span>
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8h.html#31cd3f5f977f81e4dc95f3e9ad595453">USB_DMA_Disable</a> (uint32_t EPNum) {
<a name="l00555"></a>00555   <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpDMADis = 1 &lt;&lt; <a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum);
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 <span class="comment">/*</span>
<a name="l00560"></a>00560 <span class="comment"> *  Get USB DMA Endpoint Status</span>
<a name="l00561"></a>00561 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00562"></a>00562 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00563"></a>00563 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00564"></a>00564 <span class="comment"> *    Return Value:    DMA Status</span>
<a name="l00565"></a>00565 <span class="comment"> */</span>
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8h.html#8ee34fca3195939c6054e7fffa973850">USB_DMA_Status</a> (uint32_t EPNum) {
<a name="l00568"></a>00568   uint32_t ptr, val;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   ptr = UDCA[<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)];                 <span class="comment">/* Current Descriptor */</span>
<a name="l00571"></a>00571   <span class="keywordflow">if</span> (ptr == 0)
<a name="l00572"></a>00572         <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#4dbf83bea31ec4e33b10ce360bfa5c39">USB_DMA_INVALID</a>);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574   val = *((uint32_t *)(ptr + 3*4));            <span class="comment">/* Status Information */</span>
<a name="l00575"></a>00575   <span class="keywordflow">switch</span> ((val &gt;&gt; 1) &amp; 0x0F) {
<a name="l00576"></a>00576     <span class="keywordflow">case</span> 0x00:                              <span class="comment">/* Not serviced */</span>
<a name="l00577"></a>00577       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#34b882057916dab0e6210e83a46857bd">USB_DMA_IDLE</a>);
<a name="l00578"></a>00578     <span class="keywordflow">case</span> 0x01:                              <span class="comment">/* Being serviced */</span>
<a name="l00579"></a>00579       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#d46e8e5431ed0381470fc06af2dc94d0">USB_DMA_BUSY</a>);
<a name="l00580"></a>00580     <span class="keywordflow">case</span> 0x02:                              <span class="comment">/* Normal Completition */</span>
<a name="l00581"></a>00581       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#639dc600bfbf182fc97e2681009714af">USB_DMA_DONE</a>);
<a name="l00582"></a>00582     <span class="keywordflow">case</span> 0x03:                              <span class="comment">/* Data Under Run */</span>
<a name="l00583"></a>00583       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#a54e14b24cf619d3a2330ced270ddd01">USB_DMA_UNDER_RUN</a>);
<a name="l00584"></a>00584     <span class="keywordflow">case</span> 0x08:                              <span class="comment">/* Data Over Run */</span>
<a name="l00585"></a>00585       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#e760f296550bf6e91f0c38a8a9228b59">USB_DMA_OVER_RUN</a>);
<a name="l00586"></a>00586     <span class="keywordflow">case</span> 0x09:                              <span class="comment">/* System Error */</span>
<a name="l00587"></a>00587       <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#edb99cfaba75fb594553e4c458d70fee">USB_DMA_ERROR</a>);
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   <span class="keywordflow">return</span> (<a class="code" href="_u_s_b_audio_2usbhw_8h.html#942e08e79439c68abd0dbb68495b17d2">USB_DMA_UNKNOWN</a>);
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="comment">/*</span>
<a name="l00595"></a>00595 <span class="comment"> *  Get USB DMA Endpoint Current Buffer Address</span>
<a name="l00596"></a>00596 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00597"></a>00597 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00598"></a>00598 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00599"></a>00599 <span class="comment"> *    Return Value:    DMA Address (or -1 when DMA is Invalid)</span>
<a name="l00600"></a>00600 <span class="comment"> */</span>
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8h.html#3af9e22c5c907f0d2497b1532f675957">USB_DMA_BufAdr</a> (uint32_t EPNum) {
<a name="l00603"></a>00603   uint32_t ptr, val;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605   ptr = UDCA[<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)];                 <span class="comment">/* Current Descriptor */</span>
<a name="l00606"></a>00606   <span class="keywordflow">if</span> (ptr == 0)
<a name="l00607"></a>00607   {
<a name="l00608"></a>00608         <span class="keywordflow">return</span> ((uint32_t)(-1));                <span class="comment">/* DMA Invalid */</span>
<a name="l00609"></a>00609   }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   val = *((uint32_t *)(ptr + 2*4));         <span class="comment">/* Buffer Address */</span>
<a name="l00612"></a>00612   <span class="keywordflow">return</span> (val);                             <span class="comment">/* Current Address */</span>
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 <span class="comment">/*</span>
<a name="l00617"></a>00617 <span class="comment"> *  Get USB DMA Endpoint Current Buffer Count</span>
<a name="l00618"></a>00618 <span class="comment"> *   Number of transfered Bytes or Iso Packets</span>
<a name="l00619"></a>00619 <span class="comment"> *    Parameters:      EPNum: Endpoint Number</span>
<a name="l00620"></a>00620 <span class="comment"> *                       EPNum.0..3: Address</span>
<a name="l00621"></a>00621 <span class="comment"> *                       EPNum.7:    Dir</span>
<a name="l00622"></a>00622 <span class="comment"> *    Return Value:    DMA Count (or -1 when DMA is Invalid)</span>
<a name="l00623"></a>00623 <span class="comment"> */</span>
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8h.html#3325ec50bda06103284368a217906fde">USB_DMA_BufCnt</a> (uint32_t EPNum) {
<a name="l00626"></a>00626   uint32_t ptr, val;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   ptr = UDCA[<a class="code" href="_u_s_b_audio_2usbhw_8c.html#1aecf030a0d76bccc83101a1cc0e870c">EPAdr</a>(EPNum)];                 <span class="comment">/* Current Descriptor */</span>
<a name="l00629"></a>00629   <span class="keywordflow">if</span> (ptr == 0)
<a name="l00630"></a>00630   {
<a name="l00631"></a>00631         <span class="keywordflow">return</span> ((uint32_t)(-1));                <span class="comment">/* DMA Invalid */</span>
<a name="l00632"></a>00632   }
<a name="l00633"></a>00633   val = *((uint32_t *)(ptr + 3*4));         <span class="comment">/* Status Information */</span>
<a name="l00634"></a>00634   <span class="keywordflow">return</span> (val &gt;&gt; 16);                       <span class="comment">/* Current Count */</span>
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 <span class="preprocessor">#endif </span><span class="comment">/* USB_DMA */</span>
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 <span class="comment">/*</span>
<a name="l00642"></a>00642 <span class="comment"> *  Get USB Last Frame Number</span>
<a name="l00643"></a>00643 <span class="comment"> *    Parameters:      None</span>
<a name="l00644"></a>00644 <span class="comment"> *    Return Value:    Frame Number</span>
<a name="l00645"></a>00645 <span class="comment"> */</span>
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#5abb5fb5a74d0f80d86c6060ebc3bfc2">00647</a> uint32_t <a class="code" href="_u_s_b_audio_2usbhw_8c.html#5abb5fb5a74d0f80d86c6060ebc3bfc2">USB_GetFrame</a> (<span class="keywordtype">void</span>) {
<a name="l00648"></a>00648   uint32_t val;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650   <a class="code" href="_u_s_b_audio_2usbhw_8c.html#43a57d8b8cb335d6c95b8517a46c244f">WrCmd</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#864767d642af234c8b755e33ee885d5f">CMD_RD_FRAME</a>);
<a name="l00651"></a>00651   val = <a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">RdCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#a29ff436c20c2fd7b40672c61331d751">DAT_RD_FRAME</a>);
<a name="l00652"></a>00652   val = val | (<a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">RdCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#a29ff436c20c2fd7b40672c61331d751">DAT_RD_FRAME</a>) &lt;&lt; 8);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654   <span class="keywordflow">return</span> (val);
<a name="l00655"></a>00655 }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">/*</span>
<a name="l00659"></a>00659 <span class="comment"> *  USB Interrupt Service Routine</span>
<a name="l00660"></a>00660 <span class="comment"> */</span>
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="_u_s_b_mass_storage_2usbhw_8h.html#0fbd54f7ff4b48c5b9a900421adf3702">00662</a> <span class="keywordtype">void</span> <a class="code" href="_u_s_b_audio_2usbhw_8c.html#0fbd54f7ff4b48c5b9a900421adf3702">USB_IRQHandler</a> (<span class="keywordtype">void</span>) {
<a name="l00663"></a>00663   uint32_t disr, val, n, m;
<a name="l00664"></a>00664   uint32_t episr, episrCur;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666   disr = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt;       <span class="comment">/* Device Interrupt Status */</span>
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="comment">/* Device Status Interrupt (Reset, Connect change, Suspend/Resume) */</span>
<a name="l00669"></a>00669   <span class="keywordflow">if</span> (disr &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#f275198989acad4e8a4e2b7e59a09c8a">DEV_STAT_INT</a>) {
<a name="l00670"></a>00670     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = DEV_STAT_INT;
<a name="l00671"></a>00671     <a class="code" href="_u_s_b_audio_2usbhw_8c.html#43a57d8b8cb335d6c95b8517a46c244f">WrCmd</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#42d3284a06de777ac4224b73401962a0">CMD_GET_DEV_STAT</a>);
<a name="l00672"></a>00672     val = <a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">RdCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#220874da8f06a7285a4358e05799f7cb">DAT_GET_DEV_STAT</a>);       <span class="comment">/* Device Status */</span>
<a name="l00673"></a>00673     <span class="keywordflow">if</span> (val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#956447cbe75fec470a14f7bf19700b21">DEV_RST</a>) {                    <span class="comment">/* Reset */</span>
<a name="l00674"></a>00674       <a class="code" href="_u_s_b_audio_2usbhw_8c.html#bfc0896707a9437a0c3b0ac611da59aa">USB_Reset</a>();
<a name="l00675"></a>00675 <span class="preprocessor">#if   USB_RESET_EVENT</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>      <a class="code" href="_u_s_b_audio_2usbuser_8c.html#81153c365777cdfe7d9e148c372c45b1">USB_Reset_Event</a>();
<a name="l00677"></a>00677 <span class="preprocessor">#endif</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span>    }
<a name="l00679"></a>00679     <span class="keywordflow">if</span> (val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#10e1a4e669ad2b4c70c64630ba1d5ded">DEV_CON_CH</a>) {                 <span class="comment">/* Connect change */</span>
<a name="l00680"></a>00680 <span class="preprocessor">#if   USB_POWER_EVENT</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span>      <a class="code" href="_u_s_b_audio_2usbuser_8h.html#b07662af2ec7631b5e69e7f9fc73e7f4">USB_Power_Event</a>(val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#5b6f5830c79daef183553eba90a74563">DEV_CON</a>);
<a name="l00682"></a>00682 <span class="preprocessor">#endif</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span>    }
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#08a297cb7ed647f49fb15ee8a1c2e7db">DEV_SUS_CH</a>) {                 <span class="comment">/* Suspend/Resume */</span>
<a name="l00685"></a>00685       <span class="keywordflow">if</span> (val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#cd7dfb56a185c8f760e5e57777295ed2">DEV_SUS</a>) {                  <span class="comment">/* Suspend */</span>
<a name="l00686"></a>00686         <a class="code" href="_u_s_b_audio_2usbhw_8c.html#87b4006411b630cc848d30b3e8a53e34">USB_Suspend</a>();
<a name="l00687"></a>00687 <span class="preprocessor">#if     USB_SUSPEND_EVENT</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span>        <a class="code" href="_u_s_b_audio_2usbuser_8h.html#ebfd6340b5852fa5ff4d00487c6371e2">USB_Suspend_Event</a>();
<a name="l00689"></a>00689 <span class="preprocessor">#endif</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> {                              <span class="comment">/* Resume */</span>
<a name="l00691"></a>00691         <a class="code" href="_u_s_b_audio_2usbhw_8c.html#690e53ae70763bf28c20fbf55b28b1c5">USB_Resume</a>();
<a name="l00692"></a>00692 <span class="preprocessor">#if     USB_RESUME_EVENT</span>
<a name="l00693"></a>00693 <span class="preprocessor"></span>        <a class="code" href="_u_s_b_audio_2usbuser_8h.html#1845c45a3015590b54446857bb30805d">USB_Resume_Event</a>();
<a name="l00694"></a>00694 <span class="preprocessor">#endif</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>      }
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697     <span class="keywordflow">goto</span> isr_end;
<a name="l00698"></a>00698   }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="preprocessor">#if USB_SOF_EVENT</span>
<a name="l00701"></a>00701 <span class="preprocessor"></span>  <span class="comment">/* Start of Frame Interrupt */</span>
<a name="l00702"></a>00702   <span class="keywordflow">if</span> (disr &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#cd810cb2c578feb523e4457a3ecc5c1f">FRAME_INT</a>) {
<a name="l00703"></a>00703     <a class="code" href="_u_s_b_audio_2usbuser_8c.html#43ab0480e52c19825f3f4fac2bee5e95">USB_SOF_Event</a>();
<a name="l00704"></a>00704   }
<a name="l00705"></a>00705 <span class="preprocessor">#endif</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>
<a name="l00707"></a>00707 <span class="preprocessor">#if USB_ERROR_EVENT</span>
<a name="l00708"></a>00708 <span class="preprocessor"></span>  <span class="comment">/* Error Interrupt */</span>
<a name="l00709"></a>00709   <span class="keywordflow">if</span> (disr &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#d008a7e4bb0e20f144f938e9bd1735ed">ERR_INT</a>) {
<a name="l00710"></a>00710     <a class="code" href="_u_s_b_audio_2usbhw_8c.html#43a57d8b8cb335d6c95b8517a46c244f">WrCmd</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#23c3adf7c197c85471213061caee8d96">CMD_RD_ERR_STAT</a>);
<a name="l00711"></a>00711     val = <a class="code" href="_u_s_b_audio_2usbhw_8c.html#4b356b28b5665c9604fa6f0d2a42fba1">RdCmdDat</a>(<a class="code" href="_u_s_b_audio_2usbreg_8h.html#7c4e0b734d257f5ed77f6c1aca3043e1">DAT_RD_ERR_STAT</a>);
<a name="l00712"></a>00712     <a class="code" href="_u_s_b_audio_2usbuser_8h.html#db3b19492f699baee67df339367515f8">USB_Error_Event</a>(val);
<a name="l00713"></a>00713   }
<a name="l00714"></a>00714 <span class="preprocessor">#endif</span>
<a name="l00715"></a>00715 <span class="preprocessor"></span>
<a name="l00716"></a>00716   <span class="comment">/* Endpoint's Slow Interrupt */</span>
<a name="l00717"></a>00717   <span class="keywordflow">if</span> (disr &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#525aa5f17d8eef8bcc680f818718c35f">EP_SLOW_INT</a>) {
<a name="l00718"></a>00718     episrCur = 0;
<a name="l00719"></a>00719     episr    = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpIntSt;
<a name="l00720"></a>00720     <span class="keywordflow">for</span> (n = 0; n &lt; <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>; n++) {      <span class="comment">/* Check All Endpoints */</span>
<a name="l00721"></a>00721       <span class="keywordflow">if</span> (episr == episrCur) <span class="keywordflow">break</span>;         <span class="comment">/* break if all EP interrupts handled */</span>
<a name="l00722"></a>00722       <span class="keywordflow">if</span> (episr &amp; (1 &lt;&lt; n)) {
<a name="l00723"></a>00723         episrCur |= (1 &lt;&lt; n);
<a name="l00724"></a>00724         m = n &gt;&gt; 1;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEpIntClr = (1 &lt;&lt; n);
<a name="l00727"></a>00727         <span class="keywordflow">while</span> ((<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntSt &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#406c6e1ace2c70ee7f264957ce417a45">CDFULL_INT</a>) == 0);
<a name="l00728"></a>00728         val = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBCmdData;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="keywordflow">if</span> ((n &amp; 1) == 0) {                 <span class="comment">/* OUT Endpoint */</span>
<a name="l00731"></a>00731           <span class="keywordflow">if</span> (n == 0) {                     <span class="comment">/* Control OUT Endpoint */</span>
<a name="l00732"></a>00732             <span class="keywordflow">if</span> (val &amp; <a class="code" href="_u_s_b_audio_2usbreg_8h.html#f5788ac50a0c00bc086f68eeb076add7">EP_SEL_STP</a>) {         <span class="comment">/* Setup Packet */</span>
<a name="l00733"></a>00733               <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[0]) {
<a name="l00734"></a>00734                 <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[0](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#0dd490d0af4c7851990f5d684677624c">USB_EVT_SETUP</a>);
<a name="l00735"></a>00735                 <span class="keywordflow">continue</span>;
<a name="l00736"></a>00736               }
<a name="l00737"></a>00737             }
<a name="l00738"></a>00738           }
<a name="l00739"></a>00739           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00740"></a>00740             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#e01491d0798fb37df5ba79e1a9381203">USB_EVT_OUT</a>);
<a name="l00741"></a>00741           }
<a name="l00742"></a>00742         } <span class="keywordflow">else</span> {                            <span class="comment">/* IN Endpoint */</span>
<a name="l00743"></a>00743           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00744"></a>00744             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#1878b7ac90c901b986cc590e48fe366e">USB_EVT_IN</a>);
<a name="l00745"></a>00745           }
<a name="l00746"></a>00746         }
<a name="l00747"></a>00747       }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDevIntClr = EP_SLOW_INT;
<a name="l00750"></a>00750   }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="preprocessor">#if USB_DMA</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>
<a name="l00754"></a>00754   <span class="keywordflow">if</span> (<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDMAIntSt &amp; 0x00000001) {          <span class="comment">/* End of Transfer Interrupt */</span>
<a name="l00755"></a>00755     val = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEoTIntSt;
<a name="l00756"></a>00756     <span class="keywordflow">for</span> (n = 2; n &lt; <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>; n++) {      <span class="comment">/* Check All Endpoints */</span>
<a name="l00757"></a>00757       <span class="keywordflow">if</span> (val &amp; (1 &lt;&lt; n)) {
<a name="l00758"></a>00758         m = n &gt;&gt; 1;
<a name="l00759"></a>00759         <span class="keywordflow">if</span> ((n &amp; 1) == 0) {                 <span class="comment">/* OUT Endpoint */</span>
<a name="l00760"></a>00760           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00761"></a>00761             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#2fc49c02289cebbe77b11b6faa14c0c1">USB_EVT_OUT_DMA_EOT</a>);
<a name="l00762"></a>00762           }
<a name="l00763"></a>00763         } <span class="keywordflow">else</span> {                            <span class="comment">/* IN Endpoint */</span>
<a name="l00764"></a>00764           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00765"></a>00765             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#230262bc3612075435eb980044809eba">USB_EVT_IN_DMA_EOT</a>);
<a name="l00766"></a>00766           }
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768       }
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBEoTIntClr = val;
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <span class="keywordflow">if</span> (<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDMAIntSt &amp; 0x00000002) {          <span class="comment">/* New DD Request Interrupt */</span>
<a name="l00774"></a>00774     val = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBNDDRIntSt;
<a name="l00775"></a>00775     <span class="keywordflow">for</span> (n = 2; n &lt; <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>; n++) {      <span class="comment">/* Check All Endpoints */</span>
<a name="l00776"></a>00776       <span class="keywordflow">if</span> (val &amp; (1 &lt;&lt; n)) {
<a name="l00777"></a>00777         m = n &gt;&gt; 1;
<a name="l00778"></a>00778         <span class="keywordflow">if</span> ((n &amp; 1) == 0) {                 <span class="comment">/* OUT Endpoint */</span>
<a name="l00779"></a>00779           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00780"></a>00780             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#012521919a767bf708ef283ccce327c5">USB_EVT_OUT_DMA_NDR</a>);
<a name="l00781"></a>00781           }
<a name="l00782"></a>00782         } <span class="keywordflow">else</span> {                            <span class="comment">/* IN Endpoint */</span>
<a name="l00783"></a>00783           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00784"></a>00784             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#981b3c0a9db4a739cb5c077197b87c35">USB_EVT_IN_DMA_NDR</a>);
<a name="l00785"></a>00785           }
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787       }
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBNDDRIntClr = val;
<a name="l00790"></a>00790   }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792   <span class="keywordflow">if</span> (<a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBDMAIntSt &amp; 0x00000004) {          <span class="comment">/* System Error Interrupt */</span>
<a name="l00793"></a>00793     val = <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBSysErrIntSt;
<a name="l00794"></a>00794     <span class="keywordflow">for</span> (n = 2; n &lt; <a class="code" href="_u_s_b_audio_2usbcfg_8h.html#14e0f34e4d2669f2f2b9025bed2c791c">USB_EP_NUM</a>; n++) {      <span class="comment">/* Check All Endpoints */</span>
<a name="l00795"></a>00795       <span class="keywordflow">if</span> (val &amp; (1 &lt;&lt; n)) {
<a name="l00796"></a>00796         m = n &gt;&gt; 1;
<a name="l00797"></a>00797         <span class="keywordflow">if</span> ((n &amp; 1) == 0) {                 <span class="comment">/* OUT Endpoint */</span>
<a name="l00798"></a>00798           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00799"></a>00799             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#2316d00d1b8566fba285b546d014110e">USB_EVT_OUT_DMA_ERR</a>);
<a name="l00800"></a>00800           }
<a name="l00801"></a>00801         } <span class="keywordflow">else</span> {                            <span class="comment">/* IN Endpoint */</span>
<a name="l00802"></a>00802           <span class="keywordflow">if</span> (<a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m]) {
<a name="l00803"></a>00803             <a class="code" href="_u_s_b_audio_2usbuser_8c.html#514462e81c61b67ae2926d326f608cd4">USB_P_EP</a>[m](<a class="code" href="_u_s_b_audio_2usbuser_8h.html#dc56456257e7b49e49af96e3cf169110">USB_EVT_IN_DMA_ERR</a>);
<a name="l00804"></a>00804           }
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806       }
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808     <a class="code" href="group___l_p_c17xx___system.html#ge77538a7f3f4850715c95283e38b423f">LPC_USB</a>-&gt;USBSysErrIntClr = val;
<a name="l00809"></a>00809   }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="preprocessor">#endif </span><span class="comment">/* USB_DMA */</span>
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 isr_end:
<a name="l00814"></a>00814   <span class="keywordflow">return</span>;
<a name="l00815"></a>00815 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Jun 7 14:59:04 2011 for LPC1700CMSIS Standard Peripheral Firmware Library Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
