<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>LPC1700CMSIS Standard Peripheral Firmware Library Manual: C:/nxpdrv/LPC1700CMSIS/Examples/EMAC/Easy_Web/tcpip.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>C:/nxpdrv/LPC1700CMSIS/Examples/EMAC/Easy_Web/tcpip.c</h1><a href="tcpip_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/******************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *****                                                        *****</span>
<a name="l00003"></a>00003 <span class="comment"> *****  Name: tcpip.c                                         *****</span>
<a name="l00004"></a>00004 <span class="comment"> *****  Ver.: 1.0                                             *****</span>
<a name="l00005"></a>00005 <span class="comment"> *****  Date: 07/05/2001                                      *****</span>
<a name="l00006"></a>00006 <span class="comment"> *****  Auth: Andreas Dannenberg                              *****</span>
<a name="l00007"></a>00007 <span class="comment"> *****        HTWK Leipzig                                    *****</span>
<a name="l00008"></a>00008 <span class="comment"> *****        university of applied sciences                  *****</span>
<a name="l00009"></a>00009 <span class="comment"> *****        Germany                                         *****</span>
<a name="l00010"></a>00010 <span class="comment"> *****  Func: implements the TCP/IP-stack and provides a      *****</span>
<a name="l00011"></a>00011 <span class="comment"> *****        simple API to the user                          *****</span>
<a name="l00012"></a>00012 <span class="comment"> *****                                                        *****</span>
<a name="l00013"></a>00013 <span class="comment"> ******************************************************************/</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="tcpip_8h.html">tcpip.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="_easy___web_2_e_m_a_c_8h.html">EMAC.h</a>"</span>         <span class="comment">// Keil: Line added</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;string.h&gt;</span>       <span class="comment">// Keil: Line added</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">// NXP: Include some header files that diifers from the origin</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="_e_m_a_c_2_easy___web_2lpc17xx__libcfg_8h.html">lpc17xx_libcfg.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="lpc17xx__pinsel_8h.html" title="Contains all macro definitions and function prototypes support for Pin connect block...">lpc17xx_pinsel.h</a>"</span>
<a name="l00022"></a>00022 <span class="comment">//#include "lpc17xx_emac.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_a_d_c_8h.html">adc.h</a>"</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">/* For debugging... */</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="debug__frmwrk_8h.html" title="Contains some utilities that used for debugging through UART.">debug_frmwrk.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00028"></a><a class="code" href="tcpip_8c.html#a1f0559f8030e9c4a7434d677c854527">00028</a> <span class="preprocessor">#define DB      _DBG((uint8_t *)db_)</span>
<a name="l00029"></a><a class="code" href="tcpip_8c.html#fec77ffb5dcb084e6e7b7e51f8a7fc88">00029</a> <span class="preprocessor"></span><span class="keywordtype">char</span> <a class="code" href="tcpip_8c.html#fec77ffb5dcb084e6e7b7e51f8a7fc88">db_</a>[64];
<a name="l00030"></a><a class="code" href="tcpip_8c.html#a411c41546af8089da905c68758e63bc">00030</a> uint16_t <a class="code" href="tcpip_8c.html#a411c41546af8089da905c68758e63bc">_tickVal</a>;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef MCB_LPC_1768</span>
<a name="l00033"></a><a class="code" href="tcpip_8c.html#b4553be4db9860d940f81d7447173b2f">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define LED_PIN (1&lt;&lt;6) // P2.6</span>
<a name="l00034"></a><a class="code" href="tcpip_8c.html#40f0f4b5ae7ea50d341105ddc740101e">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define LED2_MASK       ((1&lt;&lt;2) | (1&lt;&lt;3) | (1&lt;&lt;4) | (1&lt;&lt;5) | (1&lt;&lt;6))</span>
<a name="l00035"></a><a class="code" href="tcpip_8c.html#669ed6e073140d069b30442bf4c08842">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define LED1_MASK       ((1&lt;&lt;28) | (1&lt;&lt;29) | (1&lt;&lt;31))</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#elif defined(IAR_LPC_1768)</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#define LED_PIN (1&lt;&lt;25)  //P1.25</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define LED2_MASK ((1&lt;&lt;4))</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#define LED1_MASK ((1&lt;&lt;25))</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="tcpip_8h.html#7f70f6411b00f6f88c8d8b7b3ef88525">00042</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>[6] =   <span class="comment">// "M1-M2-M3-M4-M5-M6"</span>
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044   <a class="code" href="_easy___web_2_e_m_a_c_8h.html#7325c510e875d9573f324492b9151a43">MYMAC_1</a>, <a class="code" href="_easy___web_2_e_m_a_c_8h.html#88f578f29f47177b44751301e756bde3">MYMAC_2</a>, <a class="code" href="_easy___web_2_e_m_a_c_8h.html#a2d31279b347171aa7f732365c1f2c13">MYMAC_3</a>,
<a name="l00045"></a>00045   <a class="code" href="_easy___web_2_e_m_a_c_8h.html#d4a0a988d040fb12514a74648408cb57">MYMAC_4</a>, <a class="code" href="_easy___web_2_e_m_a_c_8h.html#629c4d9e26675eb5cc98424fd5d6f568">MYMAC_5</a>, <a class="code" href="_easy___web_2_e_m_a_c_8h.html#75eb29d382aeff0778b962a7e977870f">MYMAC_6</a>
<a name="l00046"></a>00046 };
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">// NXP LowLevel initializing implementation</span>
<a name="l00049"></a>00049 <span class="comment">// System tick period definition (in microsecond)</span>
<a name="l00050"></a><a class="code" href="tcpip_8c.html#c4be368d2c41160d8e870a97f343a526">00050</a> <span class="preprocessor">#define SYSTICK_PERIOD 210000UL</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="comment">// System tick interrupt handler prototype</span>
<a name="l00053"></a>00053 <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#gb5e09814056d617c521549e542639b7e" title="SysTick handler sub-routine (1ms).">SysTick_Handler</a> (<span class="keywordtype">void</span>);
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="group___w_d_t___i_n_t_e_r_r_u_p_t.html#gb3570a8c9e1266519ad1c7e00093812b">00055</a> <span class="keywordtype">void</span> <a class="code" href="group___cortex___m3___privilege__mode.html#gb3570a8c9e1266519ad1c7e00093812b" title="Initialize LED.">LED_Init</a> (<span class="keywordtype">void</span>)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057         <a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html" title="Pin configuration structure.">PINSEL_CFG_Type</a> PinCfg;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059         uint8_t temp;
<a name="l00060"></a>00060 <span class="preprocessor">#ifdef MCB_LPC_1768</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>        PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#37f75692d33b8746d9302e7aef40cfed">Funcnum</a> = 0;
<a name="l00062"></a>00062         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#41fdd494757916317e357a014e1e9233">OpenDrain</a> = 0;
<a name="l00063"></a>00063         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#1ef97360ee450a2fa28c1070758cd492">Pinmode</a> = 0;
<a name="l00064"></a>00064         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#15f31b7bf3c210481a3ff70d836a0a70">Portnum</a> = 2;
<a name="l00065"></a>00065         <span class="keywordflow">for</span> (temp = 2; temp &lt;= 6; temp++){
<a name="l00066"></a>00066                 PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#8445b4a5f996bd14c274925d9946cf00">Pinnum</a> = temp;
<a name="l00067"></a>00067                 <a class="code" href="group___p_i_n_s_e_l___public___functions.html#g771fcbed8f7ee806292e06e283611dc9" title="Configure Pin corresponding to specified parameters passed in the PinCfg.">PINSEL_ConfigPin</a>(&amp;PinCfg);
<a name="l00068"></a>00068         }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#37f75692d33b8746d9302e7aef40cfed">Funcnum</a> = 0;
<a name="l00071"></a>00071         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#41fdd494757916317e357a014e1e9233">OpenDrain</a> = 0;
<a name="l00072"></a>00072         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#1ef97360ee450a2fa28c1070758cd492">Pinmode</a> = 0;
<a name="l00073"></a>00073         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#15f31b7bf3c210481a3ff70d836a0a70">Portnum</a> = 1;
<a name="l00074"></a>00074         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#8445b4a5f996bd14c274925d9946cf00">Pinnum</a> = 28;
<a name="l00075"></a>00075         <a class="code" href="group___p_i_n_s_e_l___public___functions.html#g771fcbed8f7ee806292e06e283611dc9" title="Configure Pin corresponding to specified parameters passed in the PinCfg.">PINSEL_ConfigPin</a>(&amp;PinCfg);
<a name="l00076"></a>00076         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#8445b4a5f996bd14c274925d9946cf00">Pinnum</a> = 29;
<a name="l00077"></a>00077         <a class="code" href="group___p_i_n_s_e_l___public___functions.html#g771fcbed8f7ee806292e06e283611dc9" title="Configure Pin corresponding to specified parameters passed in the PinCfg.">PINSEL_ConfigPin</a>(&amp;PinCfg);
<a name="l00078"></a>00078         PinCfg.<a class="code" href="struct_p_i_n_s_e_l___c_f_g___type.html#8445b4a5f996bd14c274925d9946cf00">Pinnum</a> = 31;
<a name="l00079"></a>00079         <a class="code" href="group___p_i_n_s_e_l___public___functions.html#g771fcbed8f7ee806292e06e283611dc9" title="Configure Pin corresponding to specified parameters passed in the PinCfg.">PINSEL_ConfigPin</a>(&amp;PinCfg);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="comment">// Set direction to output</span>
<a name="l00082"></a>00082         <a class="code" href="group___l_p_c17xx___system.html#g27a09e8c08f9e209c6af70b0a3c56b39">LPC_GPIO2</a>-&gt;FIODIR |= <a class="code" href="tcpip_8c.html#40f0f4b5ae7ea50d341105ddc740101e">LED2_MASK</a>;
<a name="l00083"></a>00083         <a class="code" href="group___l_p_c17xx___system.html#g335587dad4e6d0da56c1f3ad1c087d10">LPC_GPIO1</a>-&gt;FIODIR |= <a class="code" href="tcpip_8c.html#669ed6e073140d069b30442bf4c08842">LED1_MASK</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         <span class="comment">/* Turn off all LEDs */</span>
<a name="l00086"></a>00086         <a class="code" href="group___l_p_c17xx___system.html#g27a09e8c08f9e209c6af70b0a3c56b39">LPC_GPIO2</a>-&gt;FIOCLR = <a class="code" href="tcpip_8c.html#40f0f4b5ae7ea50d341105ddc740101e">LED2_MASK</a>;
<a name="l00087"></a>00087         <a class="code" href="group___l_p_c17xx___system.html#g335587dad4e6d0da56c1f3ad1c087d10">LPC_GPIO1</a>-&gt;FIOCLR = <a class="code" href="tcpip_8c.html#669ed6e073140d069b30442bf4c08842">LED1_MASK</a>;
<a name="l00088"></a>00088 <span class="preprocessor">#elif defined(IAR_LPC_1768)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>        <a class="code" href="group___l_p_c17xx___system.html#g92f3de6ff5cfd5b8c290696fad07b18a">LPC_GPIO0</a>-&gt;FIODIR |= <a class="code" href="tcpip_8c.html#40f0f4b5ae7ea50d341105ddc740101e">LED2_MASK</a>;
<a name="l00090"></a>00090         <a class="code" href="group___l_p_c17xx___system.html#g335587dad4e6d0da56c1f3ad1c087d10">LPC_GPIO1</a>-&gt;FIODIR |= <a class="code" href="tcpip_8c.html#669ed6e073140d069b30442bf4c08842">LED1_MASK</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">/* Turn off all LEDs */</span>
<a name="l00093"></a>00093         <a class="code" href="group___l_p_c17xx___system.html#g92f3de6ff5cfd5b8c290696fad07b18a">LPC_GPIO0</a>-&gt;FIOSET = <a class="code" href="tcpip_8c.html#40f0f4b5ae7ea50d341105ddc740101e">LED2_MASK</a>;
<a name="l00094"></a>00094         <a class="code" href="group___l_p_c17xx___system.html#g335587dad4e6d0da56c1f3ad1c087d10">LPC_GPIO1</a>-&gt;FIOSET = <a class="code" href="tcpip_8c.html#669ed6e073140d069b30442bf4c08842">LED1_MASK</a>;
<a name="l00095"></a>00095 <span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>}
<a name="l00097"></a>00097 <span class="comment">// easyWEB-API function</span>
<a name="l00098"></a>00098 <span class="comment">// initalizes the LAN-controller, reset flags, starts timer-ISR</span>
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="tcpip_8h.html#af58e3872f99a532df782e434b043830">00100</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#af58e3872f99a532df782e434b043830">TCPLowLevelInit</a>(<span class="keywordtype">void</span>)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102         <span class="comment">// ADC initializing</span>
<a name="l00103"></a>00103         <a class="code" href="_a_d_c_8c.html#4b4a2ddcb45df0c8497c47d4ed800e2a">ADC_init</a>();
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         <span class="comment">// Initialize LED for system tick timer</span>
<a name="l00106"></a>00106         <a class="code" href="group___cortex___m3___privilege__mode.html#gb3570a8c9e1266519ad1c7e00093812b" title="Initialize LED.">LED_Init</a>();
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="comment">/* Initialize debug via UART0</span>
<a name="l00109"></a>00109 <span class="comment">         * – 115200bps</span>
<a name="l00110"></a>00110 <span class="comment">         * – 8 data bit</span>
<a name="l00111"></a>00111 <span class="comment">         * – No parity</span>
<a name="l00112"></a>00112 <span class="comment">         * – 1 stop bit</span>
<a name="l00113"></a>00113 <span class="comment">         * – No flow control</span>
<a name="l00114"></a>00114 <span class="comment">         */</span>
<a name="l00115"></a>00115         <a class="code" href="debug__frmwrk_8h.html#a79ebfdcc65f8acaa847e9deaecea5a0" title="*********************************************************************//**">debug_frmwrk_init</a>();
<a name="l00116"></a>00116         <a class="code" href="debug__frmwrk_8h.html#7cd3d2b30f1e1d84e9352c25d37011c2">_DBG_</a>(<span class="stringliteral">"Hello NXP EMAC"</span>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <a class="code" href="_easy___web_2_e_m_a_c_8c.html#329f55eb307f22d38492e6f59e145e8f">Init_EMAC</a>();
<a name="l00119"></a>00119         <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> = 0;
<a name="l00120"></a>00120         <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;
<a name="l00121"></a>00121         <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00122"></a>00122         <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = 0;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         <span class="comment">// NXP: Initialize System tick timer</span>
<a name="l00125"></a>00125         <span class="comment">// Generate interrupt each SYSTICK_PERIOD microsecond</span>
<a name="l00126"></a>00126         <span class="keywordflow">if</span> (SysTick_Config((4000000/1000000)*<a class="code" href="tcpip_8c.html#c4be368d2c41160d8e870a97f343a526">SYSTICK_PERIOD</a>)){
<a name="l00127"></a>00127                 <span class="comment">// Capture error</span>
<a name="l00128"></a>00128                 <span class="keywordflow">while</span> (1);
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         <a class="code" href="debug__frmwrk_8h.html#7cd3d2b30f1e1d84e9352c25d37011c2">_DBG_</a>(<span class="stringliteral">"Init LowLevelTCP complete!"</span>);
<a name="l00131"></a>00131         <a class="code" href="printf-stdarg_8c.html#a0649118bc3728b2a62af0b47606ff51">sprintf</a>(<a class="code" href="tcpip_8c.html#fec77ffb5dcb084e6e7b7e51f8a7fc88">db_</a>, <span class="stringliteral">"IP Address: %d.%d.%d.%d \n\r"</span>, <a class="code" href="tcpip_8h.html#314b8b1509fa2479b6e7e727c746b1ba">MYIP_1</a>, <a class="code" href="tcpip_8h.html#eea8cae416884fbd2cccb5f77847b4f5">MYIP_2</a>, <a class="code" href="tcpip_8h.html#216d82e83931dc57a7dd266bc4710b11">MYIP_3</a>, <a class="code" href="tcpip_8h.html#32b76d3842c75612db17d8447af73e50">MYIP_4</a>);
<a name="l00132"></a>00132         <a class="code" href="_easy___web_2_e_m_a_c_8c.html#a1f0559f8030e9c4a7434d677c854527">DB</a>;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">// easyWEB-API function</span>
<a name="l00136"></a>00136 <span class="comment">// does a passive open (listen on 'MyIP:TCPLocalPort' for an incoming</span>
<a name="l00137"></a>00137 <span class="comment">// connection)</span>
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="tcpip_8h.html#f2b5ece140b96ad5c17f8dc17fbf7f03">00139</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#f2b5ece140b96ad5c17f8dc17fbf7f03">TCPPassiveOpen</a>(<span class="keywordtype">void</span>)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>)
<a name="l00142"></a>00142   {
<a name="l00143"></a>00143     <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp;= ~<a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a>;                <span class="comment">// let's do a passive open!</span>
<a name="l00144"></a>00144     <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9121e214ebac934264f5b9e3ddffae1031">LISTENING</a>;
<a name="l00145"></a>00145     <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#981f2cbabc281c1874f616446554b07d">SOCK_ACTIVE</a>;                  <span class="comment">// reset, socket now active</span>
<a name="l00146"></a>00146   }
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">// easyWEB-API function</span>
<a name="l00150"></a>00150 <span class="comment">// does an active open (tries to establish a connection between</span>
<a name="l00151"></a>00151 <span class="comment">// 'MyIP:TCPLocalPort' and 'RemoteIP:TCPRemotePort')</span>
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="tcpip_8h.html#0bbfedca4e46a76d7b5834a6ce5f999e">00153</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#0bbfedca4e46a76d7b5834a6ce5f999e">TCPActiveOpen</a>(<span class="keywordtype">void</span>)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155   <span class="keywordflow">if</span> ((<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>) || (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9121e214ebac934264f5b9e3ddffae1031">LISTENING</a>))
<a name="l00156"></a>00156   {
<a name="l00157"></a>00157     <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a>;                 <span class="comment">// let's do an active open!</span>
<a name="l00158"></a>00158     <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp;= ~<a class="code" href="tcpip_8h.html#dd744f368d101fd7995b63fbdbc7f9c7">IP_ADDR_RESOLVED</a>;               <span class="comment">// we haven't opponents MAC yet</span>
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <a class="code" href="tcpip_8c.html#132ab18b3f9c87a224222f7a4d90ea51">PrepareARP_REQUEST</a>();                        <span class="comment">// ask for MAC by sending a broadcast</span>
<a name="l00161"></a>00161     <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="group__uiparp.html#g7a7c46ffaba30477b8c9e3e61bd2e106">ARP_REQUEST</a>;
<a name="l00162"></a>00162     <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();
<a name="l00163"></a>00163     <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#981f2cbabc281c1874f616446554b07d">SOCK_ACTIVE</a>;                  <span class="comment">// reset, socket now active</span>
<a name="l00164"></a>00164   }
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="comment">// easyWEB-API function</span>
<a name="l00168"></a>00168 <span class="comment">// closes an open connection</span>
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="tcpip_8h.html#cfc0e8e28fc7f5705dc88a730aa5db41">00170</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#cfc0e8e28fc7f5705dc88a730aa5db41">TCPClose</a>(<span class="keywordtype">void</span>)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172   <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a>)
<a name="l00173"></a>00173   {
<a name="l00174"></a>00174     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9121e214ebac934264f5b9e3ddffae1031">LISTENING</a> :
<a name="l00175"></a>00175     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea913884e45cc6d937b234e2a8c2c933d7e5">SYN_SENT</a> :
<a name="l00176"></a>00176     {
<a name="l00177"></a>00177       <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00178"></a>00178       <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;
<a name="l00179"></a>00179       <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = 0;
<a name="l00180"></a>00180       <span class="keywordflow">break</span>;
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a> :
<a name="l00183"></a>00183     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a> :
<a name="l00184"></a>00184     {
<a name="l00185"></a>00185       <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#f2259066dab53eac6cef450336d153fd">TCP_CLOSE_REQUESTED</a>;
<a name="l00186"></a>00186       <span class="keywordflow">break</span>;
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188   }
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="comment">// easyWEB-API function</span>
<a name="l00192"></a>00192 <span class="comment">// releases the receive-buffer and allows easyWEB to store new data</span>
<a name="l00193"></a>00193 <span class="comment">// NOTE: rx-buffer MUST be released periodically, else the other TCP</span>
<a name="l00194"></a>00194 <span class="comment">//       get no ACKs for the data it sent</span>
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="tcpip_8h.html#594a6cd2c86d28d44d10ea4eb4f304b1">00196</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#594a6cd2c86d28d44d10ea4eb4f304b1">TCPReleaseRxBuffer</a>(<span class="keywordtype">void</span>)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198   <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= ~<a class="code" href="tcpip_8h.html#c0de067b57b1a25893b4b319687050cb">SOCK_DATA_AVAILABLE</a>;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="comment">// easyWEB-API function</span>
<a name="l00202"></a>00202 <span class="comment">// transmitts data stored in 'TCP_TX_BUF'</span>
<a name="l00203"></a>00203 <span class="comment">// NOTE: * number of bytes to transmit must have been written to 'TCPTxDataCount'</span>
<a name="l00204"></a>00204 <span class="comment">//       * data-count MUST NOT exceed 'MAX_TCP_TX_DATA_SIZE'</span>
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="tcpip_8h.html#1b2e6011170f5d0488552c4b6216921d">00206</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#1b2e6011170f5d0488552c4b6216921d">TCPTransmitTxBuffer</a>(<span class="keywordtype">void</span>)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208   <span class="keywordflow">if</span> ((<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a>) || (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91dbf32c37bc28f37e44d0fe611d341178">CLOSE_WAIT</a>))
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp; <a class="code" href="tcpip_8h.html#c53341d2a68a06ec28e0c62c3d54cadf">SOCK_TX_BUF_RELEASED</a>)
<a name="l00210"></a>00210     {
<a name="l00211"></a>00211       <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= ~SOCK_TX_BUF_RELEASED;               <span class="comment">// occupy tx-buffer</span>
<a name="l00212"></a>00212       <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a> += <a class="code" href="tcpip_8h.html#a4685f94119a1295bbb609f9dc8c71a5">TCPTxDataCount</a>;                       <span class="comment">// advance UNA</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214       <a class="code" href="tcpip_8h.html#4441f8642fce36238c61f1aae0c952dc">TxFrame1Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#a4685f94119a1295bbb609f9dc8c71a5">TCPTxDataCount</a>;
<a name="l00215"></a>00215       <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#779a6713190d0be5eed50af2d6995286">SEND_FRAME1</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217       <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8fd268a4452661c03f6d3e414166ec057">TCP_DATA_FRAME</a>;
<a name="l00218"></a>00218       <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment">// Reads the length of the received ethernet frame and checks if the</span>
<a name="l00223"></a>00223 <span class="comment">// destination address is a broadcast message or not</span>
<a name="l00224"></a><a class="code" href="tcpip_8c.html#555a7ae26ff1900d576bf5ac361c9de6">00224</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="tcpip_8c.html#555a7ae26ff1900d576bf5ac361c9de6">IsBroadcast</a>(<span class="keywordtype">void</span>) {
<a name="l00225"></a>00225   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> RecdDestMAC[3];         <span class="comment">// 48 bit MAC</span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   <a class="code" href="tcpip_8h.html#ad01865921c29e2d9af1c27e0fd571b5">RecdFrameLength</a> = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#2fc342534e2db89a6531315cc3b99a1c">StartReadFrame</a>();
<a name="l00228"></a>00228 
<a name="l00229"></a>00229   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;RecdDestMAC,  6);           <span class="comment">// receive DA to see if it was a broadcast</span>
<a name="l00230"></a>00230   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);           <span class="comment">// store SA (for our answer)</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   <span class="keywordflow">if</span> ((RecdDestMAC[0] == 0xFFFF) &amp;&amp;
<a name="l00233"></a>00233       (RecdDestMAC[1] == 0xFFFF) &amp;&amp;
<a name="l00234"></a>00234       (RecdDestMAC[2] == 0xFFFF)) {
<a name="l00235"></a>00235     <span class="keywordflow">return</span>(1);
<a name="l00236"></a>00236   } <span class="keywordflow">else</span> {
<a name="l00237"></a>00237     <span class="keywordflow">return</span> (0);
<a name="l00238"></a>00238   }
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">// easyWEB's 'main()'-function</span>
<a name="l00243"></a>00243 <span class="comment">// must be called from user program periodically (the often - the better)</span>
<a name="l00244"></a>00244 <span class="comment">// handles network, TCP/IP-stack and user events</span>
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="tcpip_8h.html#547747e66b57c642c54f2d3817fc9a03">00246</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#547747e66b57c642c54f2d3817fc9a03">DoNetworkStuff</a>(<span class="keywordtype">void</span>)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248   <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#54235af1c9c42fd18c3ea1caad97ca4b">CheckFrameReceived</a>())                      <span class="comment">// Packet received</span>
<a name="l00249"></a>00249   {
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (<a class="code" href="tcpip_8c.html#555a7ae26ff1900d576bf5ac361c9de6">IsBroadcast</a>()) {
<a name="l00251"></a>00251       <a class="code" href="tcpip_8c.html#7346a66e6a3a2aed4c706d6a98531daa">ProcessEthBroadcastFrame</a>();
<a name="l00252"></a>00252     } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253       <a class="code" href="tcpip_8c.html#4c52e7d4dc21ab1b34e892fb534245df">ProcessEthIAFrame</a>();
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     <a class="code" href="_easy___web_2_e_m_a_c_8c.html#72f4541b2abeb49e7d0ee6ca0f372852">EndReadFrame</a>();                              <span class="comment">// release buffer in ethernet controller</span>
<a name="l00256"></a>00256   }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; <a class="code" href="tcpip_8h.html#6faa51a31b7a3b0e27e031a419c67d38">TCP_TIMER_RUNNING</a>)
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; <a class="code" href="tcpip_8h.html#8314cf2479b3d4a620e71b78eb89eef3">TIMER_TYPE_RETRY</a>)
<a name="l00260"></a>00260     {
<a name="l00261"></a>00261       <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a> &gt; <a class="code" href="tcpip_8h.html#b28fa84742de00ea3342319de160ff37">RETRY_TIMEOUT</a>)
<a name="l00262"></a>00262       {
<a name="l00263"></a>00263         <a class="code" href="tcpip_8c.html#6ac9404f2bbc31727e1211987db83250">TCPRestartTimer</a>();                       <span class="comment">// set a new timeout</span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#e5e99702b96eb65aa1353b5195a1dd7f">RetryCounter</a>)
<a name="l00266"></a>00266         {
<a name="l00267"></a>00267           <a class="code" href="tcpip_8c.html#48930bec34f6876f5230d93fd9ce7081">TCPHandleRetransmission</a>();             <span class="comment">// resend last frame</span>
<a name="l00268"></a>00268           <a class="code" href="tcpip_8h.html#e5e99702b96eb65aa1353b5195a1dd7f">RetryCounter</a>--;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         <span class="keywordflow">else</span>
<a name="l00271"></a>00271         {
<a name="l00272"></a>00272           <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>();
<a name="l00273"></a>00273           <a class="code" href="tcpip_8c.html#66a7bdf2dabfe6bd8cba5cc0304c0f35">TCPHandleTimeout</a>();
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275       }
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a> &gt; <a class="code" href="tcpip_8h.html#84decda795f6bed0026dee441fdb301a">FIN_TIMEOUT</a>)
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279       <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00280"></a>00280       <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                              <span class="comment">// reset all flags, stop retransmission...</span>
<a name="l00281"></a>00281       <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= <a class="code" href="tcpip_8h.html#c0de067b57b1a25893b4b319687050cb">SOCK_DATA_AVAILABLE</a>;       <span class="comment">// clear all flags but data available</span>
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a>)
<a name="l00285"></a>00285   {
<a name="l00286"></a>00286     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a> :
<a name="l00287"></a>00287     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9121e214ebac934264f5b9e3ddffae1031">LISTENING</a> :
<a name="l00288"></a>00288     {
<a name="l00289"></a>00289       <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; <a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a>)            <span class="comment">// stack has to open a connection?</span>
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; <a class="code" href="tcpip_8h.html#dd744f368d101fd7995b63fbdbc7f9c7">IP_ADDR_RESOLVED</a>)         <span class="comment">// IP resolved?</span>
<a name="l00291"></a>00291           <span class="keywordflow">if</span> (!(<a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp; <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>))  <span class="comment">// buffer free?</span>
<a name="l00292"></a>00292           {
<a name="l00293"></a>00293             <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = ((<span class="keywordtype">unsigned</span> long)<a class="code" href="tcpip_8h.html#914211fe1ad2b52231e7cac8e26fa0b5">ISNGenHigh</a> &lt;&lt; 16) | (<a class="code" href="group___c_m_s_i_s__core__register.html#gcd96c53beeaff8f603fcda425eb295de">SysTick</a>-&gt;VAL &amp; 0xFFFF);  <span class="comment">// NXP: changed from T0TC to SysTick-&gt;VAL;</span>
<a name="l00294"></a>00294                                                                 <span class="comment">// set local ISN</span>
<a name="l00295"></a>00295             <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a> = <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a>;
<a name="l00296"></a>00296             <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a> = 0;                                       <span class="comment">// we don't know what to ACK!</span>
<a name="l00297"></a>00297             <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>++;                                      <span class="comment">// count SYN as a byte</span>
<a name="l00298"></a>00298             <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>);                     <span class="comment">// send SYN frame</span>
<a name="l00299"></a>00299             <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8cf635bdbe9b92cbe54a4c220a80e7b4d">TCP_SYN_FRAME</a>;
<a name="l00300"></a>00300             <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();                               <span class="comment">// we NEED a retry-timeout</span>
<a name="l00301"></a>00301             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea913884e45cc6d937b234e2a8c2c933d7e5">SYN_SENT</a>;
<a name="l00302"></a>00302           }
<a name="l00303"></a>00303       <span class="keywordflow">break</span>;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a> :
<a name="l00306"></a>00306     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a> :
<a name="l00307"></a>00307     {
<a name="l00308"></a>00308       <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; <a class="code" href="tcpip_8h.html#f2259066dab53eac6cef450336d153fd">TCP_CLOSE_REQUESTED</a>)                  <span class="comment">// user has user initated a close?</span>
<a name="l00309"></a>00309         <span class="keywordflow">if</span> (!(<a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp; (<a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a> | <a class="code" href="tcpip_8h.html#779a6713190d0be5eed50af2d6995286">SEND_FRAME1</a>)))   <span class="comment">// buffers free?</span>
<a name="l00310"></a>00310           <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> == <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>)                          <span class="comment">// all data ACKed?</span>
<a name="l00311"></a>00311           {
<a name="l00312"></a>00312             <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>++;
<a name="l00313"></a>00313             <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#b4e58145c6e6f028e6b94e73b9a9964f">TCP_CODE_FIN</a> | <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>);
<a name="l00314"></a>00314             <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8b8ad777c36edd8ab871e3b35c84b74db">TCP_FIN_FRAME</a>;
<a name="l00315"></a>00315             <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();
<a name="l00316"></a>00316             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea912ca754767c3666fc17fe7f5bf49e7518">FIN_WAIT_1</a>;
<a name="l00317"></a>00317           }
<a name="l00318"></a>00318       <span class="keywordflow">break</span>;
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91dbf32c37bc28f37e44d0fe611d341178">CLOSE_WAIT</a> :
<a name="l00321"></a>00321     {
<a name="l00322"></a>00322       <span class="keywordflow">if</span> (!(<a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp; (<a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a> | <a class="code" href="tcpip_8h.html#779a6713190d0be5eed50af2d6995286">SEND_FRAME1</a>)))     <span class="comment">// buffers free?</span>
<a name="l00323"></a>00323         <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> == <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>)                            <span class="comment">// all data ACKed?</span>
<a name="l00324"></a>00324         {
<a name="l00325"></a>00325           <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>++;                                        <span class="comment">// count FIN as a byte</span>
<a name="l00326"></a>00326           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#b4e58145c6e6f028e6b94e73b9a9964f">TCP_CODE_FIN</a> | <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>);        <span class="comment">// we NEED a retry-timeout</span>
<a name="l00327"></a>00327           <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8b8ad777c36edd8ab871e3b35c84b74db">TCP_FIN_FRAME</a>;                        <span class="comment">// time to say goodbye...</span>
<a name="l00328"></a>00328           <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();
<a name="l00329"></a>00329           <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea911b588a108a727c1de55f818cb9ff57eb">LAST_ACK</a>;
<a name="l00330"></a>00330         }
<a name="l00331"></a>00331       <span class="keywordflow">break</span>;
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp; <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>)
<a name="l00336"></a>00336   {
<a name="l00337"></a>00337     <a class="code" href="_easy___web_2_e_m_a_c_8c.html#e6d83b53ca50b9d92a52cdd67d710669">RequestSend</a>(<a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#885c4d662ebde263043e432637490150">Rdy4Tx</a>()) {                               <span class="comment">// NOTE: when using a very fast MCU, maybe</span>
<a name="l00340"></a>00340         <a class="code" href="debug__frmwrk_8h.html#7cd3d2b30f1e1d84e9352c25d37011c2">_DBG_</a>(<span class="stringliteral">"Send Frm2"</span>);
<a name="l00341"></a>00341         <a class="code" href="tcpip_8c.html#3fa2422c51f288c3fe346e00bd195cec">SendFrame2</a>();                              <span class="comment">// the EMAC isn't ready yet, include</span>
<a name="l00342"></a>00342     } <span class="keywordflow">else</span> {                                       <span class="comment">// a kind of timer or counter here</span>
<a name="l00343"></a>00343       <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00344"></a>00344       <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#4a837f41a7f2ef6f755a38913d23ab9e">SOCK_ERR_ETHERNET</a>;          <span class="comment">// indicate an error to user</span>
<a name="l00345"></a>00345       <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                              <span class="comment">// clear all flags, stop timers etc.</span>
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp;= ~SEND_FRAME2;             <span class="comment">// clear tx-flag</span>
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp; <a class="code" href="tcpip_8h.html#779a6713190d0be5eed50af2d6995286">SEND_FRAME1</a>)
<a name="l00352"></a>00352   {
<a name="l00353"></a>00353     <a class="code" href="tcpip_8c.html#4d6da3ddbe9be494cac242bec9b76e19">PrepareTCP_DATA_FRAME</a>();                     <span class="comment">// build frame w/ actual SEQ, ACK....</span>
<a name="l00354"></a>00354     <a class="code" href="_easy___web_2_e_m_a_c_8c.html#e6d83b53ca50b9d92a52cdd67d710669">RequestSend</a>(<a class="code" href="tcpip_8h.html#4441f8642fce36238c61f1aae0c952dc">TxFrame1Size</a>);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#885c4d662ebde263043e432637490150">Rdy4Tx</a>()){                                <span class="comment">// EMAC ready to accept our frame?</span>
<a name="l00357"></a>00357         <a class="code" href="debug__frmwrk_8h.html#7cd3d2b30f1e1d84e9352c25d37011c2">_DBG_</a>(<span class="stringliteral">"Send Frm1"</span>);
<a name="l00358"></a>00358         <a class="code" href="tcpip_8c.html#bdefe008fd22691dc590cb796abf35f9">SendFrame1</a>();                              <span class="comment">// (see note above)</span>
<a name="l00359"></a>00359     } <span class="keywordflow">else</span> {
<a name="l00360"></a>00360       <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00361"></a>00361       <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#4a837f41a7f2ef6f755a38913d23ab9e">SOCK_ERR_ETHERNET</a>;          <span class="comment">// indicate an error to user</span>
<a name="l00362"></a>00362       <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                              <span class="comment">// clear all flags, stop timers etc.</span>
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> &amp;= ~SEND_FRAME1;             <span class="comment">// clear tx-flag</span>
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="comment">// easyWEB internal function</span>
<a name="l00370"></a>00370 <span class="comment">// handles an incoming broadcast frame</span>
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="tcpip_8h.html#7346a66e6a3a2aed4c706d6a98531daa">00372</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#7346a66e6a3a2aed4c706d6a98531daa">ProcessEthBroadcastFrame</a>(<span class="keywordtype">void</span>)
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TargetIP[2];
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#834989e3157808f71f2aaf5f76dae9a8">FRAME_ARP</a>)           <span class="comment">// get frame type, check for ARP</span>
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#6f270e06a252454000b6b375d0b72996">HARDW_ETH10</a>)       <span class="comment">// Ethernet frame</span>
<a name="l00378"></a>00378       <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>)        <span class="comment">// check protocol</span>
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#6e97efe93cb74227047eb1e5dbcd82b2">IP_HLEN_PLEN</a>)  <span class="comment">// check HLEN, PLEN</span>
<a name="l00380"></a>00380           <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#4b31d5399d2d750d1575bcdd324ac518">OP_ARP_REQUEST</a>)
<a name="l00381"></a>00381           {
<a name="l00382"></a>00382             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#ac915958347d3ddcbd4032eae1e4a89d">DummyReadFrame_EMAC</a>(6);              <span class="comment">// ignore sender's hardware address</span>
<a name="l00383"></a>00383             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4); <span class="comment">// read sender's protocol address</span>
<a name="l00384"></a>00384             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#ac915958347d3ddcbd4032eae1e4a89d">DummyReadFrame_EMAC</a>(6);              <span class="comment">// ignore target's hardware address</span>
<a name="l00385"></a>00385             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;TargetIP, 4);    <span class="comment">// read target's protocol address</span>
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (!memcmp(&amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, &amp;TargetIP, 4))    <span class="comment">// is it for us?</span>
<a name="l00387"></a>00387               <a class="code" href="tcpip_8c.html#8d8dc60f248ef92f9f6402f85a1b55ed">PrepareARP_ANSWER</a>();               <span class="comment">// yes-&gt;create ARP_ANSWER frame</span>
<a name="l00388"></a>00388           }
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">// easyWEB internal function</span>
<a name="l00392"></a>00392 <span class="comment">// handles an incoming frame that passed EMAC's address filter</span>
<a name="l00393"></a>00393 <span class="comment">// (individual addressed = IA)</span>
<a name="l00394"></a>00394 
<a name="l00395"></a><a class="code" href="tcpip_8h.html#4c52e7d4dc21ab1b34e892fb534245df">00395</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#4c52e7d4dc21ab1b34e892fb534245df">ProcessEthIAFrame</a>(<span class="keywordtype">void</span>)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TargetIP[2];
<a name="l00398"></a>00398   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ProtocolType;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400   <span class="keywordflow">switch</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>())                     <span class="comment">// get frame type</span>
<a name="l00401"></a>00401   {
<a name="l00402"></a>00402     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#834989e3157808f71f2aaf5f76dae9a8">FRAME_ARP</a> :                             <span class="comment">// check for ARP</span>
<a name="l00403"></a>00403     {
<a name="l00404"></a>00404       <span class="keywordflow">if</span> ((<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; (<a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a> | <a class="code" href="tcpip_8h.html#dd744f368d101fd7995b63fbdbc7f9c7">IP_ADDR_RESOLVED</a>)) == <a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a>)
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#6f270e06a252454000b6b375d0b72996">HARDW_ETH10</a>)         <span class="comment">// check for the right prot. etc.</span>
<a name="l00406"></a>00406           <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>)
<a name="l00407"></a>00407             <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#6e97efe93cb74227047eb1e5dbcd82b2">IP_HLEN_PLEN</a>)
<a name="l00408"></a>00408               <span class="keywordflow">if</span> (<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() == <a class="code" href="tcpip_8h.html#d7d755d34fc7ee88e79bc67a5dadf896">OP_ARP_ANSWER</a>)
<a name="l00409"></a>00409               {
<a name="l00410"></a>00410                 <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>();                       <span class="comment">// OK, now we've the MAC we wanted ;-)</span>
<a name="l00411"></a>00411                 <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;<a class="code" href="tcpip_8h.html#c8092a687665c436de9faf16853d2276">RemoteMAC</a>, 6);    <span class="comment">// extract opponents MAC</span>
<a name="l00412"></a>00412                 <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#dd744f368d101fd7995b63fbdbc7f9c7">IP_ADDR_RESOLVED</a>;
<a name="l00413"></a>00413               }
<a name="l00414"></a>00414       <span class="keywordflow">break</span>;
<a name="l00415"></a>00415     }
<a name="l00416"></a>00416     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a> :                                        <span class="comment">// check for IP-type</span>
<a name="l00417"></a>00417     {
<a name="l00418"></a>00418       <span class="keywordflow">if</span> ((<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() &amp; 0xFF00 ) == <a class="code" href="tcpip_8h.html#c2a983db03040d942b509a8c07a598db">IP_VER_IHL</a>)     <span class="comment">// IPv4, IHL=5 (20 Bytes Header)</span>
<a name="l00419"></a>00419       {                                                    <span class="comment">// ignore Type Of Service</span>
<a name="l00420"></a>00420         <a class="code" href="tcpip_8h.html#6afd1e4dce3bdb9f0891b1ec458c7817">RecdIPFrameLength</a> = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();             <span class="comment">// get IP frame's length</span>
<a name="l00421"></a>00421         <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();                                 <span class="comment">// ignore identification</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (!(<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() &amp; (<a class="code" href="tcpip_8h.html#faa97c06ce96598252cde5e5441d89ac">IP_FLAG_MOREFRAG</a> | <a class="code" href="tcpip_8h.html#765993b7793d39612d1195be6d5885ab">IP_FRAGOFS_MASK</a>)))  <span class="comment">// only unfragm. frames</span>
<a name="l00424"></a>00424         {
<a name="l00425"></a>00425           ProtocolType = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() &amp; 0xFF;         <span class="comment">// get protocol, ignore TTL</span>
<a name="l00426"></a>00426           <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();                               <span class="comment">// ignore checksum</span>
<a name="l00427"></a>00427           <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4);              <span class="comment">// get source IP</span>
<a name="l00428"></a>00428           <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;TargetIP, 4);                 <span class="comment">// get destination IP</span>
<a name="l00429"></a>00429 
<a name="l00430"></a>00430           <span class="keywordflow">if</span> (!memcmp(&amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, &amp;TargetIP, 4))                <span class="comment">// is it for us?</span>
<a name="l00431"></a>00431             <span class="keywordflow">switch</span> (ProtocolType) {
<a name="l00432"></a>00432               <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#e8e620e2c4b1bf0461c3652238c9fccd">PROT_ICMP</a> : { <a class="code" href="debug__frmwrk_8h.html#7cd3d2b30f1e1d84e9352c25d37011c2">_DBG_</a>(<span class="stringliteral">"ICMP"</span>); <a class="code" href="tcpip_8c.html#0aa81e0ecb985cb2e6acbf6697a3527c">ProcessICMPFrame</a>(); <span class="keywordflow">break</span>; }
<a name="l00433"></a>00433               <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#56ceccbbb11411d125bf8aaf48fcac21">PROT_TCP</a>  : { <a class="code" href="tcpip_8c.html#890a895f4374b0748bb6f6d3de38f7f4">ProcessTCPFrame</a>(); <span class="keywordflow">break</span>; }
<a name="l00434"></a>00434               <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#fb5ebfaff9a32a76648ad89c0ab05a11">PROT_UDP</a>  : <span class="keywordflow">break</span>;                      <span class="comment">// not implemented!</span>
<a name="l00435"></a>00435             }
<a name="l00436"></a>00436         }
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438       <span class="keywordflow">break</span>;
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="comment">// easyWEB internal function</span>
<a name="l00444"></a>00444 <span class="comment">// we've just rec'd an ICMP-frame (Internet Control Message Protocol)</span>
<a name="l00445"></a>00445 <span class="comment">// check what to do and branch to the appropriate sub-function</span>
<a name="l00446"></a>00446 
<a name="l00447"></a><a class="code" href="tcpip_8h.html#0aa81e0ecb985cb2e6acbf6697a3527c">00447</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#0aa81e0ecb985cb2e6acbf6697a3527c">ProcessICMPFrame</a>(<span class="keywordtype">void</span>)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ICMPTypeAndCode;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451   ICMPTypeAndCode = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();           <span class="comment">// get Message Type and Code</span>
<a name="l00452"></a>00452   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();                             <span class="comment">// ignore ICMP checksum</span>
<a name="l00453"></a>00453 
<a name="l00454"></a>00454   <span class="keywordflow">switch</span> (ICMPTypeAndCode &gt;&gt; 8) {                <span class="comment">// check type</span>
<a name="l00455"></a>00455     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#d58231410d58e34b455328b888a9e73c">ICMP_ECHO</a> :                             <span class="comment">// is echo request?</span>
<a name="l00456"></a>00456     {
<a name="l00457"></a>00457       <a class="code" href="tcpip_8c.html#5e4e096b8e902378cbebe14268976424">PrepareICMP_ECHO_REPLY</a>();                  <span class="comment">// echo as much as we can...</span>
<a name="l00458"></a>00458       <span class="keywordflow">break</span>;
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460   }
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="comment">// easyWEB internal function</span>
<a name="l00464"></a>00464 <span class="comment">// we've just rec'd an TCP-frame (Transmission Control Protocol)</span>
<a name="l00465"></a>00465 <span class="comment">// this function mainly implements the TCP state machine according to RFC793</span>
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="tcpip_8h.html#890a895f4374b0748bb6f6d3de38f7f4">00467</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#890a895f4374b0748bb6f6d3de38f7f4">ProcessTCPFrame</a>(<span class="keywordtype">void</span>)
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TCPSegSourcePort;               <span class="comment">// segment's source port</span>
<a name="l00470"></a>00470   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TCPSegDestPort;                 <span class="comment">// segment's destination port</span>
<a name="l00471"></a>00471   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> TCPSegSeq;                       <span class="comment">// segment's sequence number</span>
<a name="l00472"></a>00472   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> TCPSegAck;                       <span class="comment">// segment's acknowledge number</span>
<a name="l00473"></a>00473   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TCPCode;                        <span class="comment">// TCP code and header length</span>
<a name="l00474"></a>00474   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> TCPHeaderSize;                   <span class="comment">// real TCP header length</span>
<a name="l00475"></a>00475   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> NrOfDataBytes;                  <span class="comment">// real number of data</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   TCPSegSourcePort = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();                    <span class="comment">// get ports</span>
<a name="l00478"></a>00478   TCPSegDestPort = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <span class="keywordflow">if</span> (TCPSegDestPort != <a class="code" href="tcpip_8h.html#7ff29cba20ed695ca6cbdbadf82c08e8">TCPLocalPort</a>) <span class="keywordflow">return</span>;              <span class="comment">// drop segment if port doesn't match</span>
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   TCPSegSeq = (<span class="keywordtype">unsigned</span> long)<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() &lt;&lt; 16;      <span class="comment">// get segment sequence nr.</span>
<a name="l00483"></a>00483   TCPSegSeq |= <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   TCPSegAck = (<span class="keywordtype">unsigned</span> long)<a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>() &lt;&lt; 16;      <span class="comment">// get segment acknowledge nr.</span>
<a name="l00486"></a>00486   TCPSegAck |= <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   TCPCode = <a class="code" href="_easy___web_2_e_m_a_c_8c.html#20e6ca0a61b433d2d8ffa9238cc8f41d">ReadFrameBE_EMAC</a>();                             <span class="comment">// get control bits, header length...</span>
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   TCPHeaderSize = (TCPCode &amp; <a class="code" href="tcpip_8h.html#210d15290fe9f3775afd01ecaadf8307">DATA_OFS_MASK</a>) &gt;&gt; 10;         <span class="comment">// header length in bytes</span>
<a name="l00491"></a>00491   NrOfDataBytes = <a class="code" href="tcpip_8h.html#6afd1e4dce3bdb9f0891b1ec458c7817">RecdIPFrameLength</a> - <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> - TCPHeaderSize;     <span class="comment">// seg. text length</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="keywordflow">if</span> (NrOfDataBytes &gt; <a class="code" href="tcpip_8h.html#6ee5ff4d45449a0bb5c2ab3ca75b9de9">MAX_TCP_RX_DATA_SIZE</a>) <span class="keywordflow">return</span>;        <span class="comment">// packet too large for us :...-(</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="keywordflow">if</span> (TCPHeaderSize &gt; <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a>)                     <span class="comment">// ignore options if any</span>
<a name="l00496"></a>00496     <a class="code" href="_easy___web_2_e_m_a_c_8c.html#ac915958347d3ddcbd4032eae1e4a89d">DummyReadFrame_EMAC</a>(TCPHeaderSize - <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a>);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a>)                                 <span class="comment">// implement the TCP state machine</span>
<a name="l00499"></a>00499   {
<a name="l00500"></a>00500     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a> :
<a name="l00501"></a>00501     {
<a name="l00502"></a>00502       <span class="keywordflow">if</span> (!(TCPCode &amp; <a class="code" href="tcpip_8h.html#f0d00e434919a4a92c899eb823eb480f">TCP_CODE_RST</a>))
<a name="l00503"></a>00503       {
<a name="l00504"></a>00504         <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a> = TCPSegSourcePort;
<a name="l00505"></a>00505         memcpy(&amp;<a class="code" href="tcpip_8h.html#c8092a687665c436de9faf16853d2276">RemoteMAC</a>, &amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);              <span class="comment">// save opponents MAC and IP</span>
<a name="l00506"></a>00506         memcpy(&amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4);                <span class="comment">// for later use</span>
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>)                        <span class="comment">// make the reset sequence</span>
<a name="l00509"></a>00509         {                                                  <span class="comment">// acceptable to the other</span>
<a name="l00510"></a>00510           <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = TCPSegAck;                            <span class="comment">// TCP</span>
<a name="l00511"></a>00511           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_RST);
<a name="l00512"></a>00512         }
<a name="l00513"></a>00513         <span class="keywordflow">else</span>
<a name="l00514"></a>00514         {
<a name="l00515"></a>00515           <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = 0;
<a name="l00516"></a>00516           <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a> = TCPSegSeq + NrOfDataBytes;
<a name="l00517"></a>00517           <span class="keywordflow">if</span> (TCPCode &amp; (<a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a> | <a class="code" href="tcpip_8h.html#b4e58145c6e6f028e6b94e73b9a9964f">TCP_CODE_FIN</a>)) <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>++;
<a name="l00518"></a>00518           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_RST | TCP_CODE_ACK);
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520       }
<a name="l00521"></a>00521       <span class="keywordflow">break</span>;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9121e214ebac934264f5b9e3ddffae1031">LISTENING</a> :
<a name="l00524"></a>00524     {
<a name="l00525"></a>00525       <span class="keywordflow">if</span> (!(TCPCode &amp; <a class="code" href="tcpip_8h.html#f0d00e434919a4a92c899eb823eb480f">TCP_CODE_RST</a>))                       <span class="comment">// ignore segment containing RST</span>
<a name="l00526"></a>00526       {
<a name="l00527"></a>00527         <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a> = TCPSegSourcePort;
<a name="l00528"></a>00528         memcpy(&amp;<a class="code" href="tcpip_8h.html#c8092a687665c436de9faf16853d2276">RemoteMAC</a>, &amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);              <span class="comment">// save opponents MAC and IP</span>
<a name="l00529"></a>00529         memcpy(&amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4);                <span class="comment">// for later use</span>
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>)                        <span class="comment">// reset a bad</span>
<a name="l00532"></a>00532         {                                                  <span class="comment">// acknowledgement</span>
<a name="l00533"></a>00533           <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = TCPSegAck;
<a name="l00534"></a>00534           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_RST);
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>)
<a name="l00537"></a>00537         {
<a name="l00538"></a>00538           <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a> = TCPSegSeq + 1;                           <span class="comment">// get remote ISN, next byte we expect</span>
<a name="l00539"></a>00539             <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = ((<span class="keywordtype">unsigned</span> long)<a class="code" href="tcpip_8h.html#914211fe1ad2b52231e7cac8e26fa0b5">ISNGenHigh</a> &lt;&lt; 16) | (<a class="code" href="group___c_m_s_i_s__core__register.html#gcd96c53beeaff8f603fcda425eb295de">SysTick</a>-&gt;VAL &amp; 0xFFFF);  <span class="comment">// Keil: changed from TAR to T0TC;</span>
<a name="l00540"></a>00540                                                               <span class="comment">// set local ISN</span>
<a name="l00541"></a>00541           <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a> = <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> + 1;                         <span class="comment">// one byte out -&gt; increase by one</span>
<a name="l00542"></a>00542           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_SYN | TCP_CODE_ACK);
<a name="l00543"></a>00543           <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e85031c08cb88887f05f2fd4ac845f7b5a">TCP_SYN_ACK_FRAME</a>;
<a name="l00544"></a>00544           <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();
<a name="l00545"></a>00545           <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a>;
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547       }
<a name="l00548"></a>00548       <span class="keywordflow">break</span>;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea913884e45cc6d937b234e2a8c2c933d7e5">SYN_SENT</a> :
<a name="l00551"></a>00551     {
<a name="l00552"></a>00552       <span class="keywordflow">if</span> (memcmp(&amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4)) <span class="keywordflow">break</span>;  <span class="comment">// drop segment if its IP doesn't belong</span>
<a name="l00553"></a>00553                                                       <span class="comment">// to current session</span>
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       <span class="keywordflow">if</span> (TCPSegSourcePort != <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a>) <span class="keywordflow">break</span>;   <span class="comment">// drop segment if port doesn't match</span>
<a name="l00556"></a>00556 
<a name="l00557"></a>00557       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>)                <span class="comment">// ACK field significant?</span>
<a name="l00558"></a>00558         <span class="keywordflow">if</span> (TCPSegAck != <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>)            <span class="comment">// is our ISN ACKed?</span>
<a name="l00559"></a>00559         {
<a name="l00560"></a>00560           <span class="keywordflow">if</span> (!(TCPCode &amp; <a class="code" href="tcpip_8h.html#f0d00e434919a4a92c899eb823eb480f">TCP_CODE_RST</a>))
<a name="l00561"></a>00561           {
<a name="l00562"></a>00562             <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = TCPSegAck;
<a name="l00563"></a>00563             <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_RST);
<a name="l00564"></a>00564           }
<a name="l00565"></a>00565           <span class="keywordflow">break</span>;                                 <span class="comment">// drop segment</span>
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#f0d00e434919a4a92c899eb823eb480f">TCP_CODE_RST</a>)                <span class="comment">// RST??</span>
<a name="l00569"></a>00569       {
<a name="l00570"></a>00570         <span class="keywordflow">if</span> (TCPCode &amp; TCP_CODE_ACK)              <span class="comment">// if ACK was acceptable, reset</span>
<a name="l00571"></a>00571         {                                        <span class="comment">// connection</span>
<a name="l00572"></a>00572           <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00573"></a>00573           <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                          <span class="comment">// reset all flags, stop retransmission...</span>
<a name="l00574"></a>00574           <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#35e4eb9bae5c88ce6d5821c45d686ed9">SOCK_ERR_CONN_RESET</a>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         <span class="keywordflow">break</span>;                                   <span class="comment">// drop segment</span>
<a name="l00577"></a>00577       }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>)                <span class="comment">// SYN??</span>
<a name="l00580"></a>00580       {
<a name="l00581"></a>00581         <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a> = TCPSegSeq;                    <span class="comment">// get opponents ISN</span>
<a name="l00582"></a>00582         <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>++;                              <span class="comment">// inc. by one...</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         <span class="keywordflow">if</span> (TCPCode &amp; TCP_CODE_ACK)
<a name="l00585"></a>00585         {
<a name="l00586"></a>00586           <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>();                        <span class="comment">// stop retransmission, other TCP got our SYN</span>
<a name="l00587"></a>00587           <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>;                <span class="comment">// advance our sequence number</span>
<a name="l00588"></a>00588 
<a name="l00589"></a>00589           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_ACK);        <span class="comment">// ACK this ISN</span>
<a name="l00590"></a>00590           <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a>;
<a name="l00591"></a>00591           <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> |= <a class="code" href="tcpip_8h.html#0c5844aebccf04243596b04a1d3e6b46">SOCK_CONNECTED</a>;
<a name="l00592"></a>00592           <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> |= <a class="code" href="tcpip_8h.html#c53341d2a68a06ec28e0c62c3d54cadf">SOCK_TX_BUF_RELEASED</a>;  <span class="comment">// user may send data now :-)</span>
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594         <span class="keywordflow">else</span>
<a name="l00595"></a>00595         {
<a name="l00596"></a>00596           <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>();
<a name="l00597"></a>00597           <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_SYN | TCP_CODE_ACK);   <span class="comment">// our SYN isn't ACKed yet,</span>
<a name="l00598"></a>00598           <a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a> = <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e85031c08cb88887f05f2fd4ac845f7b5a">TCP_SYN_ACK_FRAME</a>;               <span class="comment">// now continue with sending</span>
<a name="l00599"></a>00599           <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>();                            <span class="comment">// SYN_ACK frames</span>
<a name="l00600"></a>00600           <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a>;
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602       }
<a name="l00603"></a>00603       <span class="keywordflow">break</span>;
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605     <span class="keywordflow">default</span> :
<a name="l00606"></a>00606     {
<a name="l00607"></a>00607       <span class="keywordflow">if</span> (memcmp(&amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4)) <span class="keywordflow">break</span>;  <span class="comment">// drop segment if IP doesn't belong</span>
<a name="l00608"></a>00608                                                       <span class="comment">// to current session</span>
<a name="l00609"></a>00609 
<a name="l00610"></a>00610       <span class="keywordflow">if</span> (TCPSegSourcePort != <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a>) <span class="keywordflow">break</span>;   <span class="comment">// drop segment if port doesn't match</span>
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       <span class="keywordflow">if</span> (TCPSegSeq != <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>) <span class="keywordflow">break</span>;               <span class="comment">// drop if it's not the segment we expect</span>
<a name="l00613"></a>00613 
<a name="l00614"></a>00614       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#f0d00e434919a4a92c899eb823eb480f">TCP_CODE_RST</a>)                <span class="comment">// RST??</span>
<a name="l00615"></a>00615       {
<a name="l00616"></a>00616         <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;                <span class="comment">// close the state machine</span>
<a name="l00617"></a>00617         <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                            <span class="comment">// reset all flags, stop retransmission...</span>
<a name="l00618"></a>00618         <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#35e4eb9bae5c88ce6d5821c45d686ed9">SOCK_ERR_CONN_RESET</a>;      <span class="comment">// indicate an error to user</span>
<a name="l00619"></a>00619         <span class="keywordflow">break</span>;
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>)                <span class="comment">// SYN??</span>
<a name="l00623"></a>00623       {
<a name="l00624"></a>00624         <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_RST);          <span class="comment">// is NOT allowed here! send a reset,</span>
<a name="l00625"></a>00625         <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;                <span class="comment">// close connection...</span>
<a name="l00626"></a>00626         <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                            <span class="comment">// reset all flags, stop retransmission...</span>
<a name="l00627"></a>00627         <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#f0df10d3caa15f98dfb48bf3b296601d">SOCK_ERR_REMOTE</a>;          <span class="comment">// fatal error!</span>
<a name="l00628"></a>00628         <span class="keywordflow">break</span>;                                   <span class="comment">// ...and drop the frame</span>
<a name="l00629"></a>00629       }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (!(TCPCode &amp; <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>)) <span class="keywordflow">break</span>;      <span class="comment">// drop segment if the ACK bit is off</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633       <span class="keywordflow">if</span> (TCPSegAck == <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>)              <span class="comment">// is our last data sent ACKed?</span>
<a name="l00634"></a>00634       {
<a name="l00635"></a>00635         <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>();                          <span class="comment">// stop retransmission</span>
<a name="l00636"></a>00636         <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a> = <a class="code" href="tcpip_8h.html#94d5a1d023246f498a6ada80b1950a83">TCPUNASeqNr</a>;                  <span class="comment">// advance our sequence number</span>
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a>)                 <span class="comment">// change state if necessary</span>
<a name="l00639"></a>00639         {
<a name="l00640"></a>00640           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a> :                        <span class="comment">// ACK of our SYN?</span>
<a name="l00641"></a>00641           {
<a name="l00642"></a>00642             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a>;       <span class="comment">// user may send data now :-)</span>
<a name="l00643"></a>00643             <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> |= <a class="code" href="tcpip_8h.html#0c5844aebccf04243596b04a1d3e6b46">SOCK_CONNECTED</a>;
<a name="l00644"></a>00644             <span class="keywordflow">break</span>;
<a name="l00645"></a>00645           }
<a name="l00646"></a>00646           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea912ca754767c3666fc17fe7f5bf49e7518">FIN_WAIT_1</a> : { <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea911ff416801732ff573184491c86ee7032">FIN_WAIT_2</a>; <span class="keywordflow">break</span>; } <span class="comment">// ACK of our FIN?</span>
<a name="l00647"></a>00647           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea918ab2cae69d2b33297ab24a5818213f18">CLOSING</a> :    { <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91799374a9f3fbdfc7f7e92c0f9c5627f7">TIME_WAIT</a>; <span class="keywordflow">break</span>; }  <span class="comment">// ACK of our FIN?</span>
<a name="l00648"></a>00648           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea911b588a108a727c1de55f818cb9ff57eb">LAST_ACK</a> :                                            <span class="comment">// ACK of our FIN?</span>
<a name="l00649"></a>00649           {
<a name="l00650"></a>00650             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00651"></a>00651             <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                        <span class="comment">// reset all flags, stop retransmission...</span>
<a name="l00652"></a>00652             <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= <a class="code" href="tcpip_8h.html#c0de067b57b1a25893b4b319687050cb">SOCK_DATA_AVAILABLE</a>; <span class="comment">// clear all flags but data available</span>
<a name="l00653"></a>00653             <span class="keywordflow">break</span>;
<a name="l00654"></a>00654           }
<a name="l00655"></a>00655           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91799374a9f3fbdfc7f7e92c0f9c5627f7">TIME_WAIT</a> :
<a name="l00656"></a>00656           {
<a name="l00657"></a>00657             <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_ACK);      <span class="comment">// ACK a retransmission of remote FIN</span>
<a name="l00658"></a>00658             <a class="code" href="tcpip_8c.html#6ac9404f2bbc31727e1211987db83250">TCPRestartTimer</a>();                   <span class="comment">// restart TIME_WAIT timeout</span>
<a name="l00659"></a>00659             <span class="keywordflow">break</span>;
<a name="l00660"></a>00660           }
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a>)      <span class="comment">// if true, give the frame buffer back</span>
<a name="l00664"></a>00664           <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> |= <a class="code" href="tcpip_8h.html#c53341d2a68a06ec28e0c62c3d54cadf">SOCK_TX_BUF_RELEASED</a>;  <span class="comment">// to user</span>
<a name="l00665"></a>00665       }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667       <span class="keywordflow">if</span> ((<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a>) || (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea912ca754767c3666fc17fe7f5bf49e7518">FIN_WAIT_1</a>) || (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> == <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea911ff416801732ff573184491c86ee7032">FIN_WAIT_2</a>))
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (NrOfDataBytes)                                 <span class="comment">// data available?</span>
<a name="l00669"></a>00669           <span class="keywordflow">if</span> (!(<a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp; <a class="code" href="tcpip_8h.html#c0de067b57b1a25893b4b319687050cb">SOCK_DATA_AVAILABLE</a>))       <span class="comment">// rx data-buffer empty?</span>
<a name="l00670"></a>00670           {
<a name="l00671"></a>00671             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#ac915958347d3ddcbd4032eae1e4a89d">DummyReadFrame_EMAC</a>(6);                        <span class="comment">// ignore window, checksum, urgent pointer</span>
<a name="l00672"></a>00672             <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(<a class="code" href="tcpip_8h.html#1d38961e7bb8671a0a8455dd22e1acc8">RxTCPBuffer</a>, NrOfDataBytes);<span class="comment">// fetch data and</span>
<a name="l00673"></a>00673             <a class="code" href="tcpip_8h.html#957a8f212f5e6c03aaf2334361003c9e">TCPRxDataCount</a> = NrOfDataBytes;                <span class="comment">// ...tell the user...</span>
<a name="l00674"></a>00674             <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> |= SOCK_DATA_AVAILABLE;           <span class="comment">// indicate the new data to user</span>
<a name="l00675"></a>00675             <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a> += NrOfDataBytes;
<a name="l00676"></a>00676             <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_ACK);                <span class="comment">// ACK rec'd data</span>
<a name="l00677"></a>00677           }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679       <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#b4e58145c6e6f028e6b94e73b9a9964f">TCP_CODE_FIN</a>)                <span class="comment">// FIN??</span>
<a name="l00680"></a>00680       {
<a name="l00681"></a>00681         <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a>)
<a name="l00682"></a>00682         {
<a name="l00683"></a>00683           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91fd8e36f3b706499ade0763cf914b99c9">SYN_RECD</a> :
<a name="l00684"></a>00684           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea9181d0d81381abb711562b19a00a4cb9af">ESTABLISHED</a> :
<a name="l00685"></a>00685           {
<a name="l00686"></a>00686             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91dbf32c37bc28f37e44d0fe611d341178">CLOSE_WAIT</a>;
<a name="l00687"></a>00687             <span class="keywordflow">break</span>;
<a name="l00688"></a>00688           }
<a name="l00689"></a>00689           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea912ca754767c3666fc17fe7f5bf49e7518">FIN_WAIT_1</a> :
<a name="l00690"></a>00690           {                                      <span class="comment">// if our FIN was ACKed, we automatically</span>
<a name="l00691"></a>00691             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea918ab2cae69d2b33297ab24a5818213f18">CLOSING</a>;           <span class="comment">// enter FIN_WAIT_2 (look above) and therefore</span>
<a name="l00692"></a>00692             <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= ~<a class="code" href="tcpip_8h.html#0c5844aebccf04243596b04a1d3e6b46">SOCK_CONNECTED</a>;     <span class="comment">// TIME_WAIT</span>
<a name="l00693"></a>00693             <span class="keywordflow">break</span>;
<a name="l00694"></a>00694           }
<a name="l00695"></a>00695           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea911ff416801732ff573184491c86ee7032">FIN_WAIT_2</a> :
<a name="l00696"></a>00696           {
<a name="l00697"></a>00697             <a class="code" href="tcpip_8c.html#787500e69369d01d18d1eb8197c7da6b">TCPStartTimeWaitTimer</a>();
<a name="l00698"></a>00698             <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91799374a9f3fbdfc7f7e92c0f9c5627f7">TIME_WAIT</a>;
<a name="l00699"></a>00699             <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> &amp;= ~<a class="code" href="tcpip_8h.html#0c5844aebccf04243596b04a1d3e6b46">SOCK_CONNECTED</a>;
<a name="l00700"></a>00700             <span class="keywordflow">break</span>;
<a name="l00701"></a>00701           }
<a name="l00702"></a>00702           <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91799374a9f3fbdfc7f7e92c0f9c5627f7">TIME_WAIT</a> :
<a name="l00703"></a>00703           {
<a name="l00704"></a>00704             <a class="code" href="tcpip_8c.html#6ac9404f2bbc31727e1211987db83250">TCPRestartTimer</a>();
<a name="l00705"></a>00705             <span class="keywordflow">break</span>;
<a name="l00706"></a>00706           }
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708         <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>++;                              <span class="comment">// ACK remote's FIN flag</span>
<a name="l00709"></a>00709         <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(TCP_CODE_ACK);
<a name="l00710"></a>00710       }
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712   }
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">// easyWEB internal function</span>
<a name="l00716"></a>00716 <span class="comment">// prepares the TxFrame2-buffer to send an ARP-request</span>
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="tcpip_8h.html#132ab18b3f9c87a224222f7a4d90ea51">00718</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#132ab18b3f9c87a224222f7a4d90ea51">PrepareARP_REQUEST</a>(<span class="keywordtype">void</span>)
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720   <span class="comment">// Ethernet</span>
<a name="l00721"></a>00721   memset(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f9bdf30fbf113e3f8c835413ee5c9b76">ETH_DA_OFS</a>], (<span class="keywordtype">char</span>)0xFF, 6);                  <span class="comment">// we don't know opposites MAC!</span>
<a name="l00722"></a>00722   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#d7079f8f5c8b5d65fc23490be4c97eb7">ETH_SA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00723"></a>00723   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#6ae62d7a39aa2bd167949b6108ab5065">ETH_TYPE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#834989e3157808f71f2aaf5f76dae9a8">FRAME_ARP</a>);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725   <span class="comment">// ARP</span>
<a name="l00726"></a>00726   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1f30e1637b7fb82ddc343ce85b40b049">ARP_HARDW_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6f270e06a252454000b6b375d0b72996">HARDW_ETH10</a>);
<a name="l00727"></a>00727   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#5358f528383251ba8ebee33db9fa391c">ARP_PROT_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>);
<a name="l00728"></a>00728   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1f396fa6101c6f5948238e47a8771d16">ARP_HLEN_PLEN_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6e97efe93cb74227047eb1e5dbcd82b2">IP_HLEN_PLEN</a>);
<a name="l00729"></a>00729   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#b4942fabefee66571c117ec0975ed8ee">ARP_OPCODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#4b31d5399d2d750d1575bcdd324ac518">OP_ARP_REQUEST</a>);
<a name="l00730"></a>00730   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#436da4c8938b6c012b63e0abbeeb0225">ARP_SENDER_HA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00731"></a>00731   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#bdcab06a56eb367ba51fe8c1aa6259fb">ARP_SENDER_IP_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, 4);
<a name="l00732"></a>00732   memset(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#7ca8be15f128dbda5d3f4919456b9e73">ARP_TARGET_HA_OFS</a>], 0x00, 6);           <span class="comment">// we don't know opposites MAC!</span>
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   <span class="keywordflow">if</span> (((<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>[0] ^ <a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>[0]) &amp; <a class="code" href="tcpip_8h.html#1e960b18fe3381418ebb63fc046c3fc6">SubnetMask</a>[0]) || ((<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>[1] ^ MyIP[1]) &amp; SubnetMask[1]))
<a name="l00735"></a>00735     memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1026140ff80c2aa2c76134f242e14df6">ARP_TARGET_IP_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#f1b4d40b516a87e3c4310fc0a00c1532">GatewayIP</a>, 4);   <span class="comment">// IP not in subnet, use gateway</span>
<a name="l00736"></a>00736   <span class="keywordflow">else</span>
<a name="l00737"></a>00737     memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[ARP_TARGET_IP_OFS], &amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, 4);    <span class="comment">// other IP is next to us...</span>
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#11e6360716e0fde98dc92aeffeaac828">ARP_FRAME_SIZE</a>;
<a name="l00740"></a>00740   <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="comment">// easyWEB internal function</span>
<a name="l00744"></a>00744 <span class="comment">// prepares the TxFrame2-buffer to send an ARP-answer (reply)</span>
<a name="l00745"></a>00745 
<a name="l00746"></a><a class="code" href="tcpip_8h.html#8d8dc60f248ef92f9f6402f85a1b55ed">00746</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#8d8dc60f248ef92f9f6402f85a1b55ed">PrepareARP_ANSWER</a>(<span class="keywordtype">void</span>)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748   <span class="comment">// Ethernet</span>
<a name="l00749"></a>00749   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f9bdf30fbf113e3f8c835413ee5c9b76">ETH_DA_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);
<a name="l00750"></a>00750   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#d7079f8f5c8b5d65fc23490be4c97eb7">ETH_SA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00751"></a>00751   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#6ae62d7a39aa2bd167949b6108ab5065">ETH_TYPE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#834989e3157808f71f2aaf5f76dae9a8">FRAME_ARP</a>);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="comment">// ARP</span>
<a name="l00754"></a>00754   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1f30e1637b7fb82ddc343ce85b40b049">ARP_HARDW_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6f270e06a252454000b6b375d0b72996">HARDW_ETH10</a>);
<a name="l00755"></a>00755   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#5358f528383251ba8ebee33db9fa391c">ARP_PROT_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>);
<a name="l00756"></a>00756   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1f396fa6101c6f5948238e47a8771d16">ARP_HLEN_PLEN_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6e97efe93cb74227047eb1e5dbcd82b2">IP_HLEN_PLEN</a>);
<a name="l00757"></a>00757   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#b4942fabefee66571c117ec0975ed8ee">ARP_OPCODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#d7d755d34fc7ee88e79bc67a5dadf896">OP_ARP_ANSWER</a>);
<a name="l00758"></a>00758   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#436da4c8938b6c012b63e0abbeeb0225">ARP_SENDER_HA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00759"></a>00759   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#bdcab06a56eb367ba51fe8c1aa6259fb">ARP_SENDER_IP_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, 4);
<a name="l00760"></a>00760   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#7ca8be15f128dbda5d3f4919456b9e73">ARP_TARGET_HA_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);
<a name="l00761"></a>00761   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#1026140ff80c2aa2c76134f242e14df6">ARP_TARGET_IP_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763   <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#11e6360716e0fde98dc92aeffeaac828">ARP_FRAME_SIZE</a>;
<a name="l00764"></a>00764   <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>;
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">// easyWEB internal function</span>
<a name="l00768"></a>00768 <span class="comment">// prepares the TxFrame2-buffer to send an ICMP-echo-reply</span>
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="tcpip_8h.html#5e4e096b8e902378cbebe14268976424">00770</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#5e4e096b8e902378cbebe14268976424">PrepareICMP_ECHO_REPLY</a>(<span class="keywordtype">void</span>)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ICMPDataCount;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8h.html#6afd1e4dce3bdb9f0891b1ec458c7817">RecdIPFrameLength</a> &gt; <a class="code" href="tcpip_8h.html#07fa3b3206b1edb807bd6a8b8faef812">MAX_ETH_TX_DATA_SIZE</a>)                      <span class="comment">// don't overload TX-buffer</span>
<a name="l00775"></a>00775     ICMPDataCount = <a class="code" href="tcpip_8h.html#07fa3b3206b1edb807bd6a8b8faef812">MAX_ETH_TX_DATA_SIZE</a> - <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> - <a class="code" href="tcpip_8h.html#f38a94f3f97e5c0b22a53e961b0fcb3a">ICMP_HEADER_SIZE</a>;
<a name="l00776"></a>00776   <span class="keywordflow">else</span>
<a name="l00777"></a>00777     ICMPDataCount = <a class="code" href="tcpip_8h.html#6afd1e4dce3bdb9f0891b1ec458c7817">RecdIPFrameLength</a> - <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> - ICMP_HEADER_SIZE;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779   <span class="comment">// Ethernet</span>
<a name="l00780"></a>00780   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f9bdf30fbf113e3f8c835413ee5c9b76">ETH_DA_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#fe6e54c9fd7d344f515c22952cc0a9d0">RecdFrameMAC</a>, 6);
<a name="l00781"></a>00781   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#d7079f8f5c8b5d65fc23490be4c97eb7">ETH_SA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00782"></a>00782   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#6ae62d7a39aa2bd167949b6108ab5065">ETH_TYPE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784   <span class="comment">// IP</span>
<a name="l00785"></a>00785   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#c2a983db03040d942b509a8c07a598db">IP_VER_IHL</a>);
<a name="l00786"></a>00786   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#00ccd6b67699e9eeac685cd2c5b752f3">IP_TOTAL_LENGTH_OFS</a>], <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + ICMP_HEADER_SIZE + ICMPDataCount);
<a name="l00787"></a>00787   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f615529c554cc32804829b81740758c0">IP_IDENT_OFS</a>] = 0;
<a name="l00788"></a>00788   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#5817d332ec0199044ae6246c6d313a8d">IP_FLAGS_FRAG_OFS</a>] = 0;
<a name="l00789"></a>00789   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ad32adc18a6e9b4e4fa913b8faeae062">IP_TTL_PROT_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>((<a class="code" href="tcpip_8h.html#a9b73542f958f4edfe5ebea8efe0ff8b">DEFAULT_TTL</a> &lt;&lt; 8) | <a class="code" href="tcpip_8h.html#e8e620e2c4b1bf0461c3652238c9fccd">PROT_ICMP</a>);
<a name="l00790"></a>00790   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = 0;
<a name="l00791"></a>00791   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#0dc830b6c39a099d7855c9672bf8d2b0">IP_SOURCE_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, 4);
<a name="l00792"></a>00792   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#3939d94914d64c487fe29bd9cdc7034a">IP_DESTINATION_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#f3f33d6a11a96ff1ce71120a72afd1c4">RecdFrameIP</a>, 4);
<a name="l00793"></a>00793   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>], <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a>, 0);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795   <span class="comment">// ICMP</span>
<a name="l00796"></a>00796   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#2ccf80ae5eef032cc1b1ff20d20e2b61">ICMP_TYPE_CODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#5c5b1834e497f53ad0ef947bbe9777fa">ICMP_ECHO_REPLY</a> &lt;&lt; 8);
<a name="l00797"></a>00797   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#9913340104b339d612e7c0dfdb9525bf">ICMP_CHKSUM_OFS</a>] = 0;                   <span class="comment">// initialize checksum field</span>
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#1a7dca81ea5d770353e4206fefe042c5">CopyFromFrame_EMAC</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#66c0c66cb583f421075594c784516ac1">ICMP_DATA_OFS</a>], ICMPDataCount);        <span class="comment">// get data to echo...</span>
<a name="l00800"></a>00800   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#9913340104b339d612e7c0dfdb9525bf">ICMP_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ce34fe9452c15cd1db7c38dc6406c2e6">IP_DATA_OFS</a>], ICMPDataCount + ICMP_HEADER_SIZE, 0);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802   <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + ICMP_HEADER_SIZE + ICMPDataCount;
<a name="l00803"></a>00803   <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 <span class="comment">// easyWEB internal function</span>
<a name="l00807"></a>00807 <span class="comment">// prepares the TxFrame2-buffer to send a general TCP frame</span>
<a name="l00808"></a>00808 <span class="comment">// the TCPCode-field is passed as an argument</span>
<a name="l00809"></a>00809 
<a name="l00810"></a><a class="code" href="tcpip_8h.html#4684ed0805168ebe534846b2d4efecd0">00810</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> TCPCode)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812   <span class="comment">// Ethernet</span>
<a name="l00813"></a>00813   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f9bdf30fbf113e3f8c835413ee5c9b76">ETH_DA_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#c8092a687665c436de9faf16853d2276">RemoteMAC</a>, 6);
<a name="l00814"></a>00814   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#d7079f8f5c8b5d65fc23490be4c97eb7">ETH_SA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00815"></a>00815   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#6ae62d7a39aa2bd167949b6108ab5065">ETH_TYPE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817   <span class="comment">// IP</span>
<a name="l00818"></a>00818   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#c2a983db03040d942b509a8c07a598db">IP_VER_IHL</a> | <a class="code" href="tcpip_8h.html#76211d9a68bed3049d52def26cb3cc23">IP_TOS_D</a>);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820   <span class="keywordflow">if</span> (TCPCode &amp; <a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>)                    <span class="comment">// if SYN, we want to use the MSS option</span>
<a name="l00821"></a>00821     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#00ccd6b67699e9eeac685cd2c5b752f3">IP_TOTAL_LENGTH_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#3f562f740244fe93d743ec33a63fdadf">TCP_OPT_MSS_SIZE</a>);
<a name="l00822"></a>00822   <span class="keywordflow">else</span>
<a name="l00823"></a>00823     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#00ccd6b67699e9eeac685cd2c5b752f3">IP_TOTAL_LENGTH_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a>);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#f615529c554cc32804829b81740758c0">IP_IDENT_OFS</a>] = 0;
<a name="l00826"></a>00826   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#5817d332ec0199044ae6246c6d313a8d">IP_FLAGS_FRAG_OFS</a>] = 0;
<a name="l00827"></a>00827   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ad32adc18a6e9b4e4fa913b8faeae062">IP_TTL_PROT_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>((<a class="code" href="tcpip_8h.html#a9b73542f958f4edfe5ebea8efe0ff8b">DEFAULT_TTL</a> &lt;&lt; 8) | <a class="code" href="tcpip_8h.html#56ceccbbb11411d125bf8aaf48fcac21">PROT_TCP</a>);
<a name="l00828"></a>00828   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = 0;
<a name="l00829"></a>00829   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#0dc830b6c39a099d7855c9672bf8d2b0">IP_SOURCE_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, 4);
<a name="l00830"></a>00830   memcpy(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#3939d94914d64c487fe29bd9cdc7034a">IP_DESTINATION_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, 4);
<a name="l00831"></a>00831   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>], <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a>, 0);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833   <span class="comment">// TCP</span>
<a name="l00834"></a>00834   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#de40027d1ce5254700ce42f80aca7322">TCP_SRCPORT_OFS</a>], <a class="code" href="tcpip_8h.html#7ff29cba20ed695ca6cbdbadf82c08e8">TCPLocalPort</a>);
<a name="l00835"></a>00835   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#8cda56a74f0240775ba399f94e068b97">TCP_DESTPORT_OFS</a>], <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a>);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   <a class="code" href="tcpip_8c.html#f8d9732a041efca335e05733673a13cb">WriteDWBE</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#fa39b59173e2ed2f0e0be7bef1f3e13f">TCP_SEQNR_OFS</a>], <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a>);
<a name="l00838"></a>00838   <a class="code" href="tcpip_8c.html#f8d9732a041efca335e05733673a13cb">WriteDWBE</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#78dfb89033d61a09746c45fea62ea08d">TCP_ACKNR_OFS</a>], <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#b71ec493b739e6c555f22a96a008df87">TCP_WINDOW_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6ee5ff4d45449a0bb5c2ab3ca75b9de9">MAX_TCP_RX_DATA_SIZE</a>);    <span class="comment">// data bytes to accept</span>
<a name="l00841"></a>00841   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#4dc5eca4e46ac8e0f2337d0be3a2aa48">TCP_CHKSUM_OFS</a>] = 0;             <span class="comment">// initalize checksum</span>
<a name="l00842"></a>00842   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#9318f22ae5a3f9155ad1d509bb16eb53">TCP_URGENT_OFS</a>] = 0;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844   <span class="keywordflow">if</span> (TCPCode &amp; TCP_CODE_SYN)                    <span class="comment">// if SYN, we want to use the MSS option</span>
<a name="l00845"></a>00845   {
<a name="l00846"></a>00846     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#3bd1ebdeed72b414b03441ddef6c5672">TCP_DATA_CODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(0x6000 | TCPCode);   <span class="comment">// TCP header length = 24</span>
<a name="l00847"></a>00847     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#688ccefe02416f846e6e7e67a4ba4344">TCP_DATA_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#691688604655ea8943d15f14c60027d8">TCP_OPT_MSS</a>);             <span class="comment">// MSS option</span>
<a name="l00848"></a>00848     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#688ccefe02416f846e6e7e67a4ba4344">TCP_DATA_OFS</a> + 2] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6ee5ff4d45449a0bb5c2ab3ca75b9de9">MAX_TCP_RX_DATA_SIZE</a>);<span class="comment">// max. length of TCP-data we accept</span>
<a name="l00849"></a>00849     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#4dc5eca4e46ac8e0f2337d0be3a2aa48">TCP_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[TCP_SRCPORT_OFS], <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#3f562f740244fe93d743ec33a63fdadf">TCP_OPT_MSS_SIZE</a>, 1);
<a name="l00850"></a>00850     <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#3f562f740244fe93d743ec33a63fdadf">TCP_OPT_MSS_SIZE</a>;
<a name="l00851"></a>00851   }
<a name="l00852"></a>00852   <span class="keywordflow">else</span>
<a name="l00853"></a>00853   {
<a name="l00854"></a>00854     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#3bd1ebdeed72b414b03441ddef6c5672">TCP_DATA_CODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(0x5000 | TCPCode);   <span class="comment">// TCP header length = 20</span>
<a name="l00855"></a>00855     *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[<a class="code" href="tcpip_8h.html#4dc5eca4e46ac8e0f2337d0be3a2aa48">TCP_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>[TCP_SRCPORT_OFS], <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a>, 1);
<a name="l00856"></a>00856     <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a> = <a class="code" href="tcpip_8h.html#3106835123967aabc7080e171ce08c5d">ETH_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a>;
<a name="l00857"></a>00857   }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859   <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#2689d609c79812b36ac3c338175b9024">SEND_FRAME2</a>;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 <span class="comment">// easyWEB internal function</span>
<a name="l00863"></a>00863 <span class="comment">// prepares the TxFrame1-buffer to send a payload-packet</span>
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="tcpip_8h.html#4d6da3ddbe9be494cac242bec9b76e19">00865</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#4d6da3ddbe9be494cac242bec9b76e19">PrepareTCP_DATA_FRAME</a>(<span class="keywordtype">void</span>)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867   <span class="comment">// Ethernet</span>
<a name="l00868"></a>00868   memcpy(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#f9bdf30fbf113e3f8c835413ee5c9b76">ETH_DA_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#c8092a687665c436de9faf16853d2276">RemoteMAC</a>, 6);
<a name="l00869"></a>00869   memcpy(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#d7079f8f5c8b5d65fc23490be4c97eb7">ETH_SA_OFS</a>], &amp;<a class="code" href="tcpip_8c.html#7f70f6411b00f6f88c8d8b7b3ef88525">MyMAC</a>, 6);
<a name="l00870"></a>00870   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#6ae62d7a39aa2bd167949b6108ab5065">ETH_TYPE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#9f333e8eb720804c8f37c07d472f8130">FRAME_IP</a>);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872   <span class="comment">// IP</span>
<a name="l00873"></a>00873   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#c2a983db03040d942b509a8c07a598db">IP_VER_IHL</a> | <a class="code" href="tcpip_8h.html#76211d9a68bed3049d52def26cb3cc23">IP_TOS_D</a>);
<a name="l00874"></a>00874   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#00ccd6b67699e9eeac685cd2c5b752f3">IP_TOTAL_LENGTH_OFS</a>], <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#a4685f94119a1295bbb609f9dc8c71a5">TCPTxDataCount</a>);
<a name="l00875"></a>00875   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#f615529c554cc32804829b81740758c0">IP_IDENT_OFS</a>] = 0;
<a name="l00876"></a>00876   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#5817d332ec0199044ae6246c6d313a8d">IP_FLAGS_FRAG_OFS</a>] = 0;
<a name="l00877"></a>00877   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#ad32adc18a6e9b4e4fa913b8faeae062">IP_TTL_PROT_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>((<a class="code" href="tcpip_8h.html#a9b73542f958f4edfe5ebea8efe0ff8b">DEFAULT_TTL</a> &lt;&lt; 8) | <a class="code" href="tcpip_8h.html#56ceccbbb11411d125bf8aaf48fcac21">PROT_TCP</a>);
<a name="l00878"></a>00878   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = 0;
<a name="l00879"></a>00879   memcpy(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#0dc830b6c39a099d7855c9672bf8d2b0">IP_SOURCE_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>, 4);
<a name="l00880"></a>00880   memcpy(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#3939d94914d64c487fe29bd9cdc7034a">IP_DESTINATION_OFS</a>], &amp;<a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>, 4);
<a name="l00881"></a>00881   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#ec7c18dd84bd74e1c555736f419d75f2">IP_HEAD_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#84eda93572084bebb8fb3f1216fa05aa">IP_VER_IHL_TOS_OFS</a>], <a class="code" href="tcpip_8h.html#21bc1a47f469b35f87dc62b1782a207d">IP_HEADER_SIZE</a>, 0);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883   <span class="comment">// TCP</span>
<a name="l00884"></a>00884   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#de40027d1ce5254700ce42f80aca7322">TCP_SRCPORT_OFS</a>], <a class="code" href="tcpip_8h.html#7ff29cba20ed695ca6cbdbadf82c08e8">TCPLocalPort</a>);
<a name="l00885"></a>00885   <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#8cda56a74f0240775ba399f94e068b97">TCP_DESTPORT_OFS</a>], <a class="code" href="tcpip_8h.html#cc453d3263ec1bf0073d164cb3427b1a">TCPRemotePort</a>);
<a name="l00886"></a>00886 
<a name="l00887"></a>00887   <a class="code" href="tcpip_8c.html#f8d9732a041efca335e05733673a13cb">WriteDWBE</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#fa39b59173e2ed2f0e0be7bef1f3e13f">TCP_SEQNR_OFS</a>], <a class="code" href="tcpip_8h.html#02b336844529edc5f1620847e4bccd75">TCPSeqNr</a>);
<a name="l00888"></a>00888   <a class="code" href="tcpip_8c.html#f8d9732a041efca335e05733673a13cb">WriteDWBE</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#78dfb89033d61a09746c45fea62ea08d">TCP_ACKNR_OFS</a>], <a class="code" href="tcpip_8h.html#3e363dfdb166984c51816c07ae616dbb">TCPAckNr</a>);
<a name="l00889"></a>00889   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#3bd1ebdeed72b414b03441ddef6c5672">TCP_DATA_CODE_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(0x5000 | <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>);   <span class="comment">// TCP header length = 20</span>
<a name="l00890"></a>00890   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#b71ec493b739e6c555f22a96a008df87">TCP_WINDOW_OFS</a>] = <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#6ee5ff4d45449a0bb5c2ab3ca75b9de9">MAX_TCP_RX_DATA_SIZE</a>);       <span class="comment">// data bytes to accept</span>
<a name="l00891"></a>00891   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#4dc5eca4e46ac8e0f2337d0be3a2aa48">TCP_CHKSUM_OFS</a>] = 0;
<a name="l00892"></a>00892   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#9318f22ae5a3f9155ad1d509bb16eb53">TCP_URGENT_OFS</a>] = 0;
<a name="l00893"></a>00893   *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[<a class="code" href="tcpip_8h.html#4dc5eca4e46ac8e0f2337d0be3a2aa48">TCP_CHKSUM_OFS</a>] = <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(&amp;<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>[TCP_SRCPORT_OFS], <a class="code" href="tcpip_8h.html#9fba9d361957423069d17225dc85390e">TCP_HEADER_SIZE</a> + <a class="code" href="tcpip_8h.html#a4685f94119a1295bbb609f9dc8c71a5">TCPTxDataCount</a>, 1);
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">// easyWEB internal function</span>
<a name="l00897"></a>00897 <span class="comment">// calculates the TCP/IP checksum. if 'IsTCP != 0', the TCP pseudo-header</span>
<a name="l00898"></a>00898 <span class="comment">// will be included.</span>
<a name="l00899"></a>00899 
<a name="l00900"></a><a class="code" href="tcpip_8h.html#8c2b5fd0c78ff9459724bd21ca65827c">00900</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="tcpip_8c.html#8c2b5fd0c78ff9459724bd21ca65827c">CalcChecksum</a>(<span class="keywordtype">void</span> *Start, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> Count, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> IsTCP)
<a name="l00901"></a>00901 {
<a name="l00902"></a>00902   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Sum = 0;
<a name="l00903"></a>00903   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> * piStart;                        <span class="comment">// Keil: Pointer added to correct expression</span>
<a name="l00904"></a>00904 
<a name="l00905"></a>00905   <span class="keywordflow">if</span> (IsTCP) {                                   <span class="comment">// if we've a TCP frame...</span>
<a name="l00906"></a>00906     Sum += <a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>[0];                              <span class="comment">// ...include TCP pseudo-header</span>
<a name="l00907"></a>00907     Sum += <a class="code" href="tcpip_8h.html#d12566188545ac503be8cf5322ffbea4">MyIP</a>[1];
<a name="l00908"></a>00908     Sum += <a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>[0];
<a name="l00909"></a>00909     Sum += <a class="code" href="tcpip_8h.html#f84b2647bca5c70d480a674a937c0f53">RemoteIP</a>[1];
<a name="l00910"></a>00910     Sum += <a class="code" href="tcpip_8c.html#9446da6828ab23c82fe2f29b9eccdc65">SwapBytes</a>(Count);                     <span class="comment">// TCP header length plus data length</span>
<a name="l00911"></a>00911     Sum += <a class="code" href="tcpip_8h.html#32c7c046581f5127f4309d9f340325c7">SWAPB</a>(<a class="code" href="tcpip_8h.html#56ceccbbb11411d125bf8aaf48fcac21">PROT_TCP</a>);
<a name="l00912"></a>00912   }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914   piStart = Start;                               <span class="comment">// Keil: Line added</span>
<a name="l00915"></a>00915   <span class="keywordflow">while</span> (Count &gt; 1) {                            <span class="comment">// sum words</span>
<a name="l00916"></a>00916 <span class="comment">//  Sum += *((unsigned short *)Start)++;                     // Keil: Line replaced with following line</span>
<a name="l00917"></a>00917     Sum += *piStart++;
<a name="l00918"></a>00918     Count -= 2;
<a name="l00919"></a>00919   }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="keywordflow">if</span> (Count)                                     <span class="comment">// add left-over byte, if any</span>
<a name="l00922"></a>00922 <span class="comment">//  Sum += *(unsigned char *)Start;              // Keil: Line replaced with following line</span>
<a name="l00923"></a>00923     Sum += *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)piStart;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925   <span class="keywordflow">while</span> (Sum &gt;&gt; 16)                              <span class="comment">// fold 32-bit sum to 16 bits</span>
<a name="l00926"></a>00926     Sum = (Sum &amp; 0xFFFF) + (Sum &gt;&gt; 16);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928   <span class="keywordflow">return</span> ~Sum;
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <span class="comment">// easyWEB internal function</span>
<a name="l00932"></a>00932 <span class="comment">// starts the timer as a retry-timer (used for retransmission-timeout)</span>
<a name="l00933"></a>00933 
<a name="l00934"></a><a class="code" href="tcpip_8h.html#8ef35a0623988e9efd10599ad252bfdb">00934</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#8ef35a0623988e9efd10599ad252bfdb">TCPStartRetryTimer</a>(<span class="keywordtype">void</span>)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936   <a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a> = 0;
<a name="l00937"></a>00937   <a class="code" href="tcpip_8h.html#e5e99702b96eb65aa1353b5195a1dd7f">RetryCounter</a> = <a class="code" href="tcpip_8h.html#c9c4c998ac10fe4e2a57295f2199ebb0">MAX_RETRYS</a>;
<a name="l00938"></a>00938   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#6faa51a31b7a3b0e27e031a419c67d38">TCP_TIMER_RUNNING</a>;
<a name="l00939"></a>00939   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#8314cf2479b3d4a620e71b78eb89eef3">TIMER_TYPE_RETRY</a>;
<a name="l00940"></a>00940 }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 <span class="comment">// easyWEB internal function</span>
<a name="l00943"></a>00943 <span class="comment">// starts the timer as a 'TIME_WAIT'-timer (used to finish a TCP-session)</span>
<a name="l00944"></a>00944 
<a name="l00945"></a><a class="code" href="tcpip_8h.html#787500e69369d01d18d1eb8197c7da6b">00945</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#787500e69369d01d18d1eb8197c7da6b">TCPStartTimeWaitTimer</a>(<span class="keywordtype">void</span>)
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947   <a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a> = 0;
<a name="l00948"></a>00948   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> |= <a class="code" href="tcpip_8h.html#6faa51a31b7a3b0e27e031a419c67d38">TCP_TIMER_RUNNING</a>;
<a name="l00949"></a>00949   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp;= ~<a class="code" href="tcpip_8h.html#8314cf2479b3d4a620e71b78eb89eef3">TIMER_TYPE_RETRY</a>;
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="comment">// easyWEB internal function</span>
<a name="l00953"></a>00953 <span class="comment">// restarts the timer</span>
<a name="l00954"></a>00954 
<a name="l00955"></a><a class="code" href="tcpip_8h.html#6ac9404f2bbc31727e1211987db83250">00955</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#6ac9404f2bbc31727e1211987db83250">TCPRestartTimer</a>(<span class="keywordtype">void</span>)
<a name="l00956"></a>00956 {
<a name="l00957"></a>00957   <a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a> = 0;
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 <span class="comment">// easyWEB internal function</span>
<a name="l00961"></a>00961 <span class="comment">// stopps the timer</span>
<a name="l00962"></a>00962 
<a name="l00963"></a><a class="code" href="tcpip_8h.html#1e82ba1837e7ebb6a50344f03b7b0cea">00963</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#1e82ba1837e7ebb6a50344f03b7b0cea">TCPStopTimer</a>(<span class="keywordtype">void</span>)
<a name="l00964"></a>00964 {
<a name="l00965"></a>00965   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp;= ~<a class="code" href="tcpip_8h.html#6faa51a31b7a3b0e27e031a419c67d38">TCP_TIMER_RUNNING</a>;
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 <span class="comment">// easyWEB internal function</span>
<a name="l00969"></a>00969 <span class="comment">// if a retransmission-timeout occured, check which packet</span>
<a name="l00970"></a>00970 <span class="comment">// to resend.</span>
<a name="l00971"></a>00971 
<a name="l00972"></a><a class="code" href="tcpip_8h.html#48930bec34f6876f5230d93fd9ce7081">00972</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#48930bec34f6876f5230d93fd9ce7081">TCPHandleRetransmission</a>(<span class="keywordtype">void</span>)
<a name="l00973"></a>00973 {
<a name="l00974"></a>00974   <span class="keywordflow">switch</span> (<a class="code" href="tcpip_8h.html#c50287c92d4d387b516e79857965dd0f">LastFrameSent</a>)
<a name="l00975"></a>00975   {
<a name="l00976"></a>00976     <span class="keywordflow">case</span> <a class="code" href="group__uiparp.html#g7a7c46ffaba30477b8c9e3e61bd2e106">ARP_REQUEST</a> :       { <a class="code" href="tcpip_8c.html#132ab18b3f9c87a224222f7a4d90ea51">PrepareARP_REQUEST</a>(); <span class="keywordflow">break</span>; }
<a name="l00977"></a>00977     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8cf635bdbe9b92cbe54a4c220a80e7b4d">TCP_SYN_FRAME</a> :     { <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a>); <span class="keywordflow">break</span>; }
<a name="l00978"></a>00978     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e85031c08cb88887f05f2fd4ac845f7b5a">TCP_SYN_ACK_FRAME</a> : { <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#641664ad49bd0cfaae29442090280b7a">TCP_CODE_SYN</a> | <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>); <span class="keywordflow">break</span>; }
<a name="l00979"></a>00979     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8b8ad777c36edd8ab871e3b35c84b74db">TCP_FIN_FRAME</a> :     { <a class="code" href="tcpip_8c.html#4684ed0805168ebe534846b2d4efecd0">PrepareTCP_FRAME</a>(<a class="code" href="tcpip_8h.html#b4e58145c6e6f028e6b94e73b9a9964f">TCP_CODE_FIN</a> | <a class="code" href="tcpip_8h.html#635d7367d80da74a37be6c2ca1c9b529">TCP_CODE_ACK</a>); <span class="keywordflow">break</span>; }
<a name="l00980"></a>00980     <span class="keywordflow">case</span> <a class="code" href="tcpip_8h.html#4a984d5d0437d51083bfe132cc44a8e8fd268a4452661c03f6d3e414166ec057">TCP_DATA_FRAME</a> :    { <a class="code" href="tcpip_8h.html#5b2221e15747d16f3fe875716a3a4d26">TransmitControl</a> |= <a class="code" href="tcpip_8h.html#779a6713190d0be5eed50af2d6995286">SEND_FRAME1</a>; <span class="keywordflow">break</span>; }
<a name="l00981"></a>00981   }
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 <span class="comment">// easyWEB internal function</span>
<a name="l00985"></a>00985 <span class="comment">// if all retransmissions failed, close connection and indicate an error</span>
<a name="l00986"></a>00986 
<a name="l00987"></a><a class="code" href="tcpip_8h.html#66a7bdf2dabfe6bd8cba5cc0304c0f35">00987</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#66a7bdf2dabfe6bd8cba5cc0304c0f35">TCPHandleTimeout</a>(<span class="keywordtype">void</span>)
<a name="l00988"></a>00988 {
<a name="l00989"></a>00989   <a class="code" href="tcpip_8h.html#c623d806ffaa27bddb84c36d174fbc5a">TCPStateMachine</a> = <a class="code" href="tcpip_8h.html#8d19d7deaea56ced25e51abf862fea91929f0327e17604ce9713b2a6117bd603">CLOSED</a>;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <span class="keywordflow">if</span> ((<a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> &amp; (<a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a> | <a class="code" href="tcpip_8h.html#dd744f368d101fd7995b63fbdbc7f9c7">IP_ADDR_RESOLVED</a>)) == <a class="code" href="tcpip_8h.html#ca2efe7f626b606a234d2d43bbf46d1e">TCP_ACTIVE_OPEN</a>)
<a name="l00992"></a>00992     <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#c5a753576fce6bb6351f8dc2428671e3">SOCK_ERR_ARP_TIMEOUT</a>;         <span class="comment">// indicate an error to user</span>
<a name="l00993"></a>00993   <span class="keywordflow">else</span>
<a name="l00994"></a>00994     <a class="code" href="tcpip_8h.html#053e31898703496056bfcc27c518476e">SocketStatus</a> = <a class="code" href="tcpip_8h.html#1fc9c192157d2f68fbb57d29e5f96ff0">SOCK_ERR_TCP_TIMEOUT</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <a class="code" href="tcpip_8h.html#97d261c053e1fed268d8b19b876fed61">TCPFlags</a> = 0;                                  <span class="comment">// clear all flags</span>
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 <span class="comment">/*</span>
<a name="l01001"></a>01001 <span class="comment"> * NXP: old TCPClockHandler() function is replaced with this function</span>
<a name="l01002"></a>01002 <span class="comment"> */</span>
<a name="l01003"></a>01003 <span class="comment">// easyWEB internal function</span>
<a name="l01004"></a>01004 <span class="comment">// function executed every 0.210s by the CPU. used for the</span>
<a name="l01005"></a>01005 <span class="comment">// inital sequence number generator (ISN) and the TCP-timer</span>
<a name="l01006"></a><a class="code" href="tcpip_8c.html#gb5e09814056d617c521549e542639b7e">01006</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#gb5e09814056d617c521549e542639b7e" title="SysTick handler sub-routine (1ms).">SysTick_Handler</a> (<span class="keywordtype">void</span>) {           <span class="comment">/* SysTick Interrupt Handler (1ms)    */</span>
<a name="l01007"></a>01007         <a class="code" href="tcpip_8h.html#914211fe1ad2b52231e7cac8e26fa0b5">ISNGenHigh</a>++;                                  <span class="comment">// upper 16 bits of initial sequence number</span>
<a name="l01008"></a>01008         <a class="code" href="tcpip_8h.html#60e22faaa3e9f1ef6b959331161a6a0a">TCPTimer</a>++;                                    <span class="comment">// timer for retransmissions</span>
<a name="l01009"></a>01009         <a class="code" href="tcpip_8c.html#a411c41546af8089da905c68758e63bc">_tickVal</a> = (++<a class="code" href="tcpip_8c.html#a411c41546af8089da905c68758e63bc">_tickVal</a>) &amp; 0x03;
<a name="l01010"></a>01010         <span class="keywordflow">if</span> (!<a class="code" href="tcpip_8c.html#a411c41546af8089da905c68758e63bc">_tickVal</a>){
<a name="l01011"></a>01011 <span class="preprocessor">#ifdef MCB_LPC_1768</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span>                <a class="code" href="group___l_p_c17xx___system.html#g27a09e8c08f9e209c6af70b0a3c56b39">LPC_GPIO2</a>-&gt;FIOPIN ^= <a class="code" href="tcpip_8c.html#b4553be4db9860d940f81d7447173b2f">LED_PIN</a>;
<a name="l01013"></a>01013 <span class="preprocessor">#elif defined(IAR_LPC_1768)</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>                <a class="code" href="group___l_p_c17xx___system.html#g335587dad4e6d0da56c1f3ad1c087d10">LPC_GPIO1</a>-&gt;FIOPIN ^= <a class="code" href="tcpip_8c.html#b4553be4db9860d940f81d7447173b2f">LED_PIN</a>;
<a name="l01015"></a>01015 <span class="preprocessor">#endif</span>
<a name="l01016"></a>01016 <span class="preprocessor"></span>        }
<a name="l01017"></a>01017 }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019 
<a name="l01020"></a>01020 <span class="comment">// easyWEB internal function</span>
<a name="l01021"></a>01021 <span class="comment">// transfers the contents of 'TxFrame1'-Buffer to the EMAC</span>
<a name="l01022"></a>01022 
<a name="l01023"></a><a class="code" href="tcpip_8h.html#bdefe008fd22691dc590cb796abf35f9">01023</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#bdefe008fd22691dc590cb796abf35f9">SendFrame1</a>(<span class="keywordtype">void</span>)
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#e76b07cc1215a035953cc7958b861356">CopyToFrame_EMAC</a>(<a class="code" href="tcpip_8h.html#5a87d390431497b5ca08a1b232862b9c">TxFrame1</a>, <a class="code" href="tcpip_8h.html#4441f8642fce36238c61f1aae0c952dc">TxFrame1Size</a>);
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 <span class="comment">// easyWEB internal function</span>
<a name="l01029"></a>01029 <span class="comment">// transfers the contents of 'TxFrame2'-Buffer to the EMAC</span>
<a name="l01030"></a>01030 
<a name="l01031"></a><a class="code" href="tcpip_8h.html#3fa2422c51f288c3fe346e00bd195cec">01031</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#3fa2422c51f288c3fe346e00bd195cec">SendFrame2</a>(<span class="keywordtype">void</span>)
<a name="l01032"></a>01032 {
<a name="l01033"></a>01033   <a class="code" href="_easy___web_2_e_m_a_c_8c.html#e76b07cc1215a035953cc7958b861356">CopyToFrame_EMAC</a>(<a class="code" href="tcpip_8h.html#4af5b81cb8e9d9c695e34505817ee946">TxFrame2</a>, <a class="code" href="tcpip_8h.html#6b9ce1d1f062ac0f751e94b8c4fa2661">TxFrame2Size</a>);
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">// easyWEB internal function</span>
<a name="l01037"></a>01037 <span class="comment">// help function to write a WORD in big-endian byte-order</span>
<a name="l01038"></a>01038 <span class="comment">// to MCU-memory</span>
<a name="l01039"></a>01039 
<a name="l01040"></a><a class="code" href="tcpip_8h.html#5105c45db4f3f6f2a205b246bd45b47f">01040</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#5105c45db4f3f6f2a205b246bd45b47f">WriteWBE</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *Add, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> Data)
<a name="l01041"></a>01041 {
<a name="l01042"></a>01042   *Add++ = Data &gt;&gt; 8;
<a name="l01043"></a>01043   *Add = (char)Data;
<a name="l01044"></a>01044 }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="comment">// easyWEB internal function</span>
<a name="l01047"></a>01047 <span class="comment">// help function to write a DWORD in big-endian byte-order</span>
<a name="l01048"></a>01048 <span class="comment">// to MCU-memory</span>
<a name="l01049"></a>01049 
<a name="l01050"></a><a class="code" href="tcpip_8h.html#f8d9732a041efca335e05733673a13cb">01050</a> <span class="keywordtype">void</span> <a class="code" href="tcpip_8c.html#f8d9732a041efca335e05733673a13cb">WriteDWBE</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *Add, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Data)
<a name="l01051"></a>01051 {
<a name="l01052"></a>01052   *Add++ = Data &gt;&gt; 24;
<a name="l01053"></a>01053   *Add++ = Data &gt;&gt; 16;
<a name="l01054"></a>01054   *Add++ = Data &gt;&gt; 8;
<a name="l01055"></a>01055   *Add = (char)Data;
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 <span class="comment">// easyWEB internal function</span>
<a name="l01059"></a>01059 <span class="comment">// help function to swap the byte order of a WORD</span>
<a name="l01060"></a>01060 
<a name="l01061"></a><a class="code" href="tcpip_8h.html#9446da6828ab23c82fe2f29b9eccdc65">01061</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="tcpip_8c.html#9446da6828ab23c82fe2f29b9eccdc65">SwapBytes</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> Data)
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063   <span class="keywordflow">return</span> (Data &gt;&gt; 8) | (Data &lt;&lt; 8);
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Jun 7 14:58:59 2011 for LPC1700CMSIS Standard Peripheral Firmware Library Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
